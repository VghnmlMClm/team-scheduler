<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#2563eb}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .day-cell{user-select:none}
    .selected-day{outline:2px solid var(--brand); outline-offset:-2px}
    .today-ring{box-shadow:inset 0 0 0 2px var(--brand)}
    .muted{opacity:.35}
    .grad{background:linear-gradient(135deg,#1d4ed8 0%,#06b6d4 100%)}
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
<header class="grad text-white">
  <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col gap-4">
    <!-- Title + Save -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-white/15 grid place-items-center"><span class="text-lg">üóìÔ∏è</span></div>
        <h1 class="text-xl sm:text-2xl font-semibold">Scheduler</h1>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="exportBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition opacity-60 cursor-not-allowed">Save</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 gap-2">
      <!-- Line 1 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <select id="selDivision"   class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading divisions‚Ä¶</option>
        </select>
        <select id="selDepartment" class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading departments‚Ä¶</option>
        </select>
        <select id="selTeam"       class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading teams‚Ä¶</option>
        </select>
      </div>
      <!-- Line 2 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <select id="selPosition"   class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading positions‚Ä¶</option>
        </select>
        <select id="selName"       class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading names‚Ä¶</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Calendar Card -->
  <section class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200">
    <div class="p-4 flex items-center justify-between gap-2 border-b">
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="p-2 rounded-lg hover:bg-slate-100" title="Previous month">‚óÄ</button>
        <button id="todayBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:opacity-95">Today</button>
        <button id="nextBtn" class="p-2 rounded-lg hover:bg-slate-100" title="Next month">‚ñ∂</button>
      </div>
      <div class="text-center">
        <h2 id="monthLabel" class="text-lg font-semibold"></h2>
        <p id="selectedCount" class="text-xs text-slate-500"></p>
      </div>
      <div class="flex items-center gap-2">
        <button id="clearSelectionBtn" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Clear selection</button>
      </div>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-7 text-xs font-medium text-slate-500 mb-2 select-none">
        <div class="text-center">Sun</div>
        <div class="text-center">Mon</div>
        <div class="text-center">Tue</div>
        <div class="text-center">Wed</div>
        <div class="text-center">Thu</div>
        <div class="text-center">Fri</div>
        <div class="text-center">Sat</div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>
  </section>

  <!-- Editor Card -->
  <aside class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="p-4 border-b">
      <h3 class="text-lg font-semibold">Set schedule for selected day(s)</h3>
      <p class="text-xs text-slate-500">Only these types are allowed. Weekends auto-grey if no status.</p>
    </div>
    <form id="eventForm" class="p-4 space-y-4" onsubmit="return false;">
      <div class="space-y-3">
        <label class="text-xs text-slate-500">Quick set status</label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <button id="btnVL" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#ed7d31">Vacation Leave</button>
          <button id="btnWFH" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#92d050">Work From Home</button>
          <button id="btnONSITE" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#548235">On-site</button>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="deleteBtn" class="px-4 py-2 rounded-xl border hover:bg-slate-50" type="button">Clear status on selected</button>
      </div>
    </form>
    <div class="px-4 pb-4">
      <h4 class="mt-2 mb-1 text-sm font-semibold">Selected:</h4>
      <div id="selectedList" class="text-sm text-slate-700"></div>
      <h4 class="mt-4 mb-1 text-sm font-semibold">Legend</h4>
      <div class="text-sm space-y-1">
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#ed7d31"></span> Vacation Leave</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#548235"></span> On-site</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#92d050"></span> Work From Home</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#BFBFBF"></span> Weekend (no status)</div>
      </div>
    </div>
  </aside>
</main>

<footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
  <p>Tip: Hold <kbd class="px-1 rounded bg-slate-200">Shift</kbd> and click to select a range. Click individual days to toggle.</p>
</footer>

<!-- ====== SCRIPT ====== -->
<script>
  // Where saved schedules live (public raw URL of your repo)
  const SCHEDULE_BASE_URL = "https://raw.githubusercontent.com/VghnmlMClm/team-scheduler/main/schedules/";
  // Proxy (Cloudflare Worker) for saving to GitHub
  const PROXY_URL = "https://frosty-water-9f6a.voughn-calma-086.workers.dev/";
  // turn "Juan Dela Cruz" ‚Üí "Juan_Dela_Cruz"
  const safeFileName = name => name.trim().replace(/\s+/g, "_");
  // strip meta keys when loading a schedule file
  const stripMeta = obj => Object.fromEntries(Object.entries(obj || {}).filter(([k]) => !k.startsWith("_")));

  const COLORS = { VL:'#ed7d31', ONSITE:'#548235', WFH:'#92d050', WEEKEND:'#BFBFBF' };
  const LABELS = { VL:'VL', ONSITE:'SITE', WFH:'WFH' };
  const pad = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseYMD = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); };

  const state = {
    viewYear: new Date().getFullYear(),
    viewMonth: new Date().getMonth(),
    selected: new Set(),
    focusDay: ymd(new Date()),
    lastClicked: null,
    storeKey: 'calendar-scheduler-v2-status-only',
    data: {}
  };

  // ===== Responders (directory) =====
  const RESPONDERS_URL = "Responders.json"; // path in your Pages repo
  let RESPONDERS = []; // array of { POSITION, DIVISION, DEPARTMENT, TEAM, NAME }

  // Helpers
  const normVal = v => String(v ?? "").trim();
  const uniq = arr => [...new Set(arr)];

  // Dropdown renderer (always includes a blank option first)
  function fillSelect(sel, values, selected, blankLabel = "‚Äî select ‚Äî") {
    sel.innerHTML =
      `<option value="">${blankLabel}</option>` +
      (values.length
        ? values.map(v => `<option value="${v}">${v}</option>`).join("")
        : `<option value="" disabled>‚Äî none ‚Äî</option>`);
    if (selected !== undefined) sel.value = selected; // selected can be ""
  }

  // Enable/disable Save button
  function setSaveEnabled(enabled) {
    const btn = document.getElementById('exportBtn');
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-60', !enabled);
    btn.classList.toggle('cursor-not-allowed', !enabled);
  }

  // Hierarchical populate with override + flexible position scope
  function populateRespondersUI(changed = null, init = false) {
    const divSel  = document.getElementById("selDivision");
    const depSel  = document.getElementById("selDepartment");
    const teamSel = document.getElementById("selTeam");
    const posSel  = document.getElementById("selPosition");
    const nameSel = document.getElementById("selName");

    // current values (may be "")
    let cur = {
      DIVISION:  normVal(divSel.value),
      DEPARTMENT:normVal(depSel.value),
      TEAM:      normVal(teamSel.value),
      POSITION:  normVal(posSel.value),
      NAME:      normVal(nameSel.value),
    };

    // Reset to the right of what changed
    if (changed === "DIVISION")   { cur.DEPARTMENT = ""; cur.TEAM = ""; cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "DEPARTMENT") { cur.TEAM = "";       cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "TEAM")       {                      cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "POSITION")   {                                       cur.NAME = ""; }

    const all = RESPONDERS;

    // DIVISION
    const divValues = uniq(all.map(r => normVal(r.DIVISION))).sort();
    if (cur.DIVISION && !divValues.includes(cur.DIVISION)) cur.DIVISION = "";
    fillSelect(divSel, divValues, cur.DIVISION, "‚Äî select division ‚Äî");
    const scopeDiv = cur.DIVISION ? all.filter(r => normVal(r.DIVISION) === cur.DIVISION) : all;

    // DEPARTMENT (limited by division)
    const depValues = uniq(scopeDiv.map(r => normVal(r.DEPARTMENT))).sort();
    if (cur.DEPARTMENT && !depValues.includes(cur.DEPARTMENT)) cur.DEPARTMENT = "";
    fillSelect(depSel, depValues, cur.DEPARTMENT, "‚Äî select department ‚Äî");
    const scopeDep = cur.DEPARTMENT ? scopeDiv.filter(r => normVal(r.DEPARTMENT) === cur.DEPARTMENT) : scopeDiv;

    // TEAM (limited by division+department) ‚Äî allow blank as "All teams"
    const teamValues = uniq(scopeDep.map(r => normVal(r.TEAM))).sort();
    if (cur.TEAM && !teamValues.includes(cur.TEAM)) cur.TEAM = "";
    fillSelect(teamSel, teamValues, cur.TEAM, "‚Äî all teams ‚Äî");

    // POSITIONS:
    // If TEAM chosen, positions from that TEAM; else from department scope (so team-less roles still appear)
    const scopeTeam = cur.TEAM ? scopeDep.filter(r => normVal(r.TEAM) === cur.TEAM) : scopeDep;
    const posValues = uniq(scopeTeam.map(r => normVal(r.POSITION))).sort();
    if (cur.POSITION && !posValues.includes(cur.POSITION)) cur.POSITION = "";
    fillSelect(posSel, posValues, cur.POSITION, "‚Äî all positions ‚Äî");

    // NAMES: from scopeTeam filtered by POSITION if set
    let scopeForNames = scopeTeam;
    if (cur.POSITION) scopeForNames = scopeForNames.filter(r => normVal(r.POSITION) === cur.POSITION);
    const nameValues = uniq(scopeForNames.map(r => normVal(r.NAME))).sort();
    if (cur.NAME && !nameValues.includes(cur.NAME)) cur.NAME = "";
    fillSelect(nameSel, nameValues, cur.NAME, "‚Äî select name ‚Äî");

    // If Name is cleared (or not yet selected), clear the calendar immediately
    if (!cur.NAME) {
      state.data = {};
      saveStore();
      render();
    }

    // Persist
    localStorage.setItem("responders-filters", JSON.stringify(cur));

    // Update Save button availability
    setSaveEnabled(!!cur.NAME);
  }

  // Schedule loader (guarded against redundant loads)
  let lastLoadedName = "";
  async function loadScheduleForName(name) {
    if (!name || name === lastLoadedName) {
      setSaveEnabled(!!name);
      return;
    }
    lastLoadedName = name;

    // clear current schedule first
    state.data = {};
    saveStore();
    render();

    const url = SCHEDULE_BASE_URL + safeFileName(name) + "_TeamSched.json";
    try {
      const res = await fetch(url, { headers: { "Accept": "application/json" }});
      if (!res.ok) {
        console.warn("No schedule found for", name, res.status);
        setSaveEnabled(true); // still allow saving a new blank schedule
        return;
      }
      const json = await res.json();

      // Strip meta and validate keys
      const loaded = stripMeta(json);
      const valid = {};
      for (const [k, v] of Object.entries(loaded)) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(k) && typeof v === "string") valid[k] = v;
      }
      state.data = valid;
      saveStore();
      render();
    } catch (e) {
      console.error("Failed to load schedule:", e);
    } finally {
      setSaveEnabled(true);
    }
  }

  async function loadResponders() {
    try {
      const res = await fetch(RESPONDERS_URL, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error(`Failed to load Responders.json (${res.status})`);
      const raw = await res.json();

      // Accept either array of objects OR object with rows‚Äînormalize to array
      const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.rows) ? raw.rows : []);
      RESPONDERS = rows.map(r => ({
        POSITION:   normVal(r.POSITION   ?? r.position),
        DIVISION:   normVal(r.DIVISION   ?? r.division),
        DEPARTMENT: normVal(r.DEPARTMENT ?? r.department),
        TEAM:       normVal(r.TEAM       ?? r.team),
        NAME:       normVal(r.NAME       ?? r.name)
      })).filter(r => r.NAME);

      // Restore previous filters if any
      const saved = JSON.parse(localStorage.getItem("responders-filters") || "null");
      if (saved) {
        document.getElementById("selDivision").value   = saved.DIVISION || "";
        document.getElementById("selDepartment").value = saved.DEPARTMENT || "";
        document.getElementById("selTeam").value       = saved.TEAM || "";
        document.getElementById("selPosition").value   = saved.POSITION || "";
        document.getElementById("selName").value       = saved.NAME || "";
      }

      populateRespondersUI(null, true);
    } catch (e) {
      console.error(e);
      // Fallback: keep controls disabled
      ["selDivision","selDepartment","selTeam","selPosition","selName"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) { el.innerHTML = `<option>Error loading</option>`; el.disabled = true; }
      });
    }
  }

  // Wire events to respect hierarchy (left change overrides everything to the right)
  function wireResponderEvents() {
    const divSel  = document.getElementById("selDivision");
    const depSel  = document.getElementById("selDepartment");
    const teamSel = document.getElementById("selTeam");
    const posSel  = document.getElementById("selPosition");
    const nameSel = document.getElementById("selName");

    divSel.addEventListener("change", () => populateRespondersUI("DIVISION"));
    depSel.addEventListener("change", () => populateRespondersUI("DEPARTMENT"));
    teamSel.addEventListener("change", () => populateRespondersUI("TEAM"));
    posSel.addEventListener("change", () => populateRespondersUI("POSITION"));

    nameSel.addEventListener("change", async () => {
      populateRespondersUI("NAME");
      await loadScheduleForName(nameSel.value);
    });
  }

  // ===== Local store helpers =====
  function loadStore(){
    try{ const raw = localStorage.getItem(state.storeKey); state.data = raw? JSON.parse(raw) : {}; }
    catch(e){ state.data = {}; }
  }
  function saveStore(){ localStorage.setItem(state.storeKey, JSON.stringify(state.data)); }

  // ===== Calendar =====
  const monthLabel = document.getElementById('monthLabel');
  const selectedCount = document.getElementById('selectedCount');
  const grid = document.getElementById('calendarGrid');
  const selectedList = document.getElementById('selectedList');

  function monthName(m){return new Date(2000,m,1).toLocaleString(undefined,{month:'long'})}

  function render(){
    const {viewYear, viewMonth} = state;
    monthLabel.textContent = `${monthName(viewMonth)} ${viewYear}`;
    renderGrid(viewYear, viewMonth);
    renderSelection();
  }

  function renderGrid(year, month){
    grid.innerHTML='';
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    const startWeekday = first.getDay();
    const daysInMonth = last.getDate();
    const prevLast = new Date(year, month, 0).getDate();
    for(let i=startWeekday-1; i>=0; i--) grid.appendChild(dayCell(new Date(year, month-1, prevLast - i), true));
    for(let d=1; d<=daysInMonth; d++) grid.appendChild(dayCell(new Date(year, month, d), false));
    const total = grid.children.length;
    const remaining = (7 - (total % 7)) % 7;
    for(let i=1;i<=remaining;i++) grid.appendChild(dayCell(new Date(year, month+1, i), true));
  }

  function dayCell(dateObj, muted=false){
    const id = ymd(dateObj);
    const isToday = id === ymd(new Date());
    const isSelected = state.selected.has(id);
    const weekday = dateObj.getDay();
    const isWeekend = (weekday===0 || weekday===6);
    const status = state.data[id] || '';
    let bg = '';
    if(status) bg = COLORS[status];
    else if(isWeekend) bg = COLORS.WEEKEND;
    const cell = document.createElement('button');
    cell.type='button';
    cell.className=`day-cell aspect-square rounded-xl border border-slate-200 p-2 text-left hover:border-blue-300 transition ${muted?'muted':''} ${isSelected?'selected-day':''}`;
    cell.dataset.date=id;
    cell.style.background=bg||'';
    const badge = status? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-black/10 border border-black/10">${LABELS[status]}</span>` : '';
    cell.innerHTML = `<div class="flex items-center justify-between"><span class="w-7 h-7 rounded-full grid place-items-center ${isToday?'today-ring':''}">${dateObj.getDate()}</span></div><div class="mt-1 overflow-hidden">${badge}</div>`;
    cell.addEventListener('click', e => onDayClick(id, e.shiftKey));
    return cell;
  }

  function onDayClick(id, shift) {
    const date = parseYMD(id);
    const weekday = date.getDay();
    // 0 = Sunday, 6 = Saturday ‚Üí block weekends
    if (weekday === 0 || weekday === 6) return;

    if (shift && state.lastClicked) {
      const a = parseYMD(state.lastClicked), b = parseYMD(id);
      const [min, max] = a <= b ? [a, b] : [b, a];
      const cur = new Date(min);
      while (cur <= max) {
        const wd = cur.getDay();
        if (wd !== 0 && wd !== 6) state.selected.add(ymd(cur)); // only add weekdays
        cur.setDate(cur.getDate() + 1);
      }
    } else {
      if (state.selected.has(id)) state.selected.delete(id);
      else state.selected.add(id);
      state.lastClicked = id;
    }
    state.focusDay = id;
    render();
  }

  function renderSelection(){
    const items = Array.from(state.selected).sort();
    selectedCount.textContent = items.length? `${items.length} day(s) selected` : 'No days selected';
    selectedList.innerHTML = items.length ? `<div class="flex flex-wrap gap-2">${items.map(d=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-100 border">${d} ‚Äî ${state.data[d]? LABELS[state.data[d]] : '‚Äî'}</span>`).join('')}</div>` : '<p class="text-xs text-slate-500">Click dates to select them.</p>';
  }

  const deleteBtn = document.getElementById('deleteBtn');
  function applyType(val){
    const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
    for(const d of targets){
      const wd = parseYMD(d).getDay();
      if (wd === 0 || wd === 6) continue; // skip weekends for safety
      state.data[d] = val;
    }
    saveStore(); state.selected.clear(); render();
  }

  document.getElementById('btnVL').onclick = ()=> applyType('VL');
  document.getElementById('btnWFH').onclick = ()=> applyType('WFH');
  document.getElementById('btnONSITE').onclick = ()=> applyType('ONSITE');

  deleteBtn.onclick = ()=>{
    if(!(state.selected.size || state.focusDay)) return;
    if(!confirm('Clear status from the selected day(s)?')) return;
    const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
    for(const d of targets){ delete state.data[d]; }
    saveStore(); render();
  };

  // ===== Save to GitHub via Cloudflare Worker =====
  async function uploadScheduleViaProxy(){
    const exportBtn = document.getElementById('exportBtn');
    const selName = document.getElementById('selName');
    const selDivision = document.getElementById('selDivision');
    const selDepartment = document.getElementById('selDepartment');
    const selTeam = document.getElementById('selTeam');
    const selPosition = document.getElementById('selPosition');

    const name = (selName.value || '').trim();
    if(!name){ alert("Pick a Name first."); selName.focus(); return; }

    if(Object.keys(state.data).length === 0){
      if(!confirm("Your schedule is empty. Save anyway?")) return;
    }

    exportBtn.disabled = true;
    const prevText = exportBtn.textContent;
    exportBtn.textContent = "Saving‚Ä¶";

    const payload = {
      name,
      data: {
        ...state.data,
        _meta: {
          division: selDivision.value,
          department: selDepartment.value,
          team: selTeam.value,
          position: selPosition.value,
          name,
          lastSaved: new Date().toISOString()
        }
      }
    };

    try{
      console.log("Uploading to:", PROXY_URL);
      const res = await fetch(PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(txt || `Save failed with status ${res.status}`);
      }

      const j = await res.json();
      const link = j.url ? `<a href="${j.url}" target="_blank" rel="noopener" class="text-blue-600 underline">View on GitHub</a>` : '';
      alert(`Saved ‚úÖ\n${j.url || ''}`);
      document.getElementById('selectedList').innerHTML =
        link || '<span class="text-xs text-slate-500">Saved.</span>';

    } catch(e){
      alert("Save failed:\n" + e.message);
    } finally {
      exportBtn.disabled = false;
      exportBtn.textContent = prevText;
    }
  }
  document.getElementById('exportBtn').onclick = uploadScheduleViaProxy;

  // ===== Init =====
  (async () => {
    loadStore();
    await loadResponders();   // fetch Responders.json and populate the selects
    wireResponderEvents();    // hook up cascading dropdown behavior
    setSaveEnabled(false);    // start disabled until a Name is chosen
    render();                 // draw the calendar
  })();
</script>
</body>
</html>
