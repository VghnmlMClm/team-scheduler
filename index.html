<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#2563eb}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background-color:#212121; /* main background */
      color:#e2e8f0;
    }

    /* Panels (personnel & dashboard) */
    #personnelView section,
    #personnelView aside,
    #dashboardView section,
    #dashboardView aside,
    .bg-slate-900 {
      background-color:#0a0f1a !important; /* darker panels */
      border-color:#1e293b !important;
    }

    /* Header gradient */
    header.grad { background:linear-gradient(135deg,#1e3a8a 0%,#0369a1 100%) }

    /* Keep calendar and schedule button colors intact */
    #schedButtons button { background: inherit; filter: none; }
    .day-cell { background: inherit; }

    /* Dark form controls */
    select,
    button:not(#schedButtons button) {
      background-color:#0f172a;
      color:#f1f5f9;
      border-color:#1e293b;
    }
    select[multiple] option { background-color:#0f172a; color:#e2e8f0; }
    button:not(#schedButtons button):hover:not(:disabled){ filter:brightness(1.12) }

    .day-cell{user-select:none}
    .selected-day{outline:2px solid var(--brand); outline-offset:-2px}
    .today-ring{box-shadow:inset 0 0 0 2px var(--brand)}
    .muted{opacity:.35}

    /* Center table sticky header matches panel bg */
    #centerTable th{position:sticky; top:0; background:#0a0f1a}

    /* Dashboard selected filter highlight (where applicable) */
    #fSupervisors option:checked {
      background-color:#fcfcfc !important;
      color:#0a0f1a !important;
    }
  </style>
</head>

<body class="text-slate-100">

<header class="grad text-white">
  <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col gap-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="toggleDashboardBtn" class="w-9 h-9 rounded-2xl bg-white/15 grid place-items-center transition" aria-label="Toggle view">
          <span id="dashIcon" class="text-lg">üóìÔ∏è</span>
        </button>
        <h1 id="appTitle" class="text-xl sm:text-2xl font-semibold">Scheduler</h1>
      </div>
		<div class="flex items-center gap-2 text-sm">
		  <!-- Dashboard-only Export menu -->
		  <div id="exportGroup" class="relative hidden">
			<button id="exportFileBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">Export</button>
			<div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-slate-900 border border-slate-700 rounded-lg shadow-lg overflow-hidden z-20">
			  <button id="exportVlBtn" class="w-full px-3 py-2 text-left hover:bg-slate-800">VL Summary (.txt)</button>
			  <button id="exportTableBtn" class="w-full px-3 py-2 text-left hover:bg-slate-800">Table (.xlsx)</button>
			</div>
		  </div>

		  <button id="loadBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 transition opacity-60 cursor-not-allowed">Refresh</button>
		  <button id="exportBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 transition opacity-60 cursor-not-allowed">Save</button>
		</div>
    </div>

    <!-- PERSONNEL FILTERS -->
    <div id="filtersWrap" class="grid grid-cols-1 gap-3 text-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label for="selTeam" class="block text-xs text-slate-300 mb-1">TEAM</label>
          <select id="selTeam" class="w-full px-3 py-1.5 rounded-lg text-sm border border-slate-700 text-white">
            <option value="">‚Äî all teams ‚Äî</option>
          </select>
        </div>
        <div>
          <label for="selPosition" class="block text-xs text-slate-300 mb-1">POSITION</label>
          <select id="selPosition" class="w-full px-3 py-1.5 rounded-lg text-sm border border-slate-700 text-white">
            <option value="">‚Äî all positions ‚Äî</option>
          </select>
        </div>
      </div>
      <div>
        <label for="selName" class="block text-xs text-slate-300 mb-1">NAME</label>
        <select id="selName" class="w-full px-3 py-1.5 rounded-lg text-sm border border-slate-700 text-white">
          <option value="">‚Äî select name ‚Äî</option>
        </select>
      </div>
    </div>
  </div>
</header>

<!-- PERSONNEL VIEW -->
<main id="personnelView" class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- CALENDAR -->
  <section class="lg:col-span-2 text-slate-100 rounded-2xl shadow-sm border border-slate-800">
    <div class="p-4 border-b border-slate-700">
      <div class="flex justify-center items-center gap-4">
        <button id="prevBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Previous month">‚óÄ</button>
        <div class="text-center">
          <h2 id="monthLabel" class="text-lg font-semibold"></h2>
          <p id="selectedCount" class="text-xs text-slate-400"></p>
        </div>
        <button id="nextBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Next month">‚ñ∂</button>
      </div>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-7 text-xs font-medium text-slate-400 mb-2 select-none">
        <div class="text-center">Sun</div><div class="text-center">Mon</div><div class="text-center">Tue</div>
        <div class="text-center">Wed</div><div class="text-center">Thu</div><div class="text-center">Fri</div><div class="text-center">Sat</div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>
  </section>

  <!-- SIDEBAR -->
  <aside class="text-slate-100 rounded-2xl shadow-sm border border-slate-800 overflow-hidden">
    <form id="eventForm" class="p-4 space-y-5" onsubmit="return false;">
      <div id="schedButtons" class="space-y-4"></div>
      <div class="flex items-center gap-3">
        <button id="deleteBtn" class="px-4 py-2 rounded-xl border border-slate-600 hover:bg-slate-800" type="button">Clear status on selected</button>
      </div>
    </form>
    <div class="px-4 pb-4 space-y-4">
      <div>
        <div class="flex items-center justify-between mb-1">
          <h4 class="text-sm font-semibold">Selected:</h4>
          <button id="clearSelectionBtn" class="px-3 py-1.5 rounded-lg border border-slate-600 hover:bg-slate-800 text-xs">Clear selection</button>
        </div>
        <div id="selectedList" class="text-sm text-slate-300"></div>
      </div>
    </div>
  </aside>
</main>

<!-- DASHBOARD VIEW -->
<section id="dashboardView" class="hidden max-w-6xl mx-auto px-4 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- LEFT: Filters -->
    <aside class="lg:col-span-3 border border-slate-800 rounded-2xl p-4">
      <h3 class="text-sm font-semibold mb-3 text-slate-200">Filters</h3>
      <div class="mb-4">
        <label class="block text-xs mb-1 text-slate-400">IMMEDIATE SUPERVISOR</label>
        <select id="fSupervisors" class="w-full border border-slate-700 rounded-lg p-2 text-sm bg-[#0f172a] text-white">
          <option value="__ALL__">-ALL-</option>
        </select>
      </div>

      <!-- WORK / LEAVE SWITCH -->
      <div class="mt-4">
        <label class="block text-xs mb-2 text-slate-400">SCHEDULE MODE</label>
        <div id="typeSwitchWrap" class="inline-flex items-center bg-slate-800/60 border border-slate-700 rounded-xl overflow-hidden">
          <button id="btnWork"  class="px-3 py-1.5 text-sm hover:bg-slate-700/60">WORK</button>
          <button id="btnLeave" class="px-3 py-1.5 text-sm hover:bg-slate-700/60">LEAVE</button>
        </div>
        <div class="text-[11px] text-slate-500 mt-2" id="typeSwitchHint"></div>
      </div>
    </aside>

    <!-- CENTER -->
    <div class="lg:col-span-6 space-y-4">
      <!-- TOTAL -->
      <div class="border border-slate-800 rounded-2xl p-4 bg-[#0a0f1a]">
        <div class="text-xs text-slate-400">TOTAL RECORDS (Selected Types)</div>
        <div id="metricTotalVl" class="text-3xl font-semibold mt-1">‚Äî</div>
      </div>

      <!-- Table -->
      <div class="border border-slate-800 rounded-2xl p-4 bg-[#0a0f1a]">
        <div class="flex items-baseline justify-between">
          <h2 class="text-sm font-semibold mb-2 text-slate-200">Dates with Selected Schedules</h2>
          <span id="currentTypeCaption" class="text-[11px] text-slate-400"></span>
        </div>
        <div class="w-full overflow-auto max-h-[520px]">
          <table id="centerTable" class="min-w-full text-sm border-separate border-spacing-y-1"></table>
        </div>
        <p id="dashboardHint" class="mt-3 text-xs text-slate-400"></p>
      </div>
    </div>

    <!-- RIGHT: Incomplete -->
    <aside class="lg:col-span-3 border border-slate-800 rounded-2xl p-4 overflow-auto">
      <h3 class="text-sm font-semibold mb-2 text-slate-200">INCOMPLETE SCHEDULES (Selected Supervisor)</h3>
      <div id="missingSubtitle" class="text-[11px] text-slate-500 mb-2">People with incomplete schedules in config range.</div>
      <div id="missingWrap" class="overflow-auto max-h-[620px]">
        <div id="missingList" class="text-sm space-y-2"></div>
      </div>
    </aside>
  </div>
</section>

<footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
  <p>Tip: Hold <kbd class="px-1 rounded bg-slate-700 text-white">Shift</kbd> and click to select a range.</p>
</footer>

<script>
/* ===== URLs ===== */
const PROXY_URL   = "https://frosty-water-9f6a.voughn-calma-086.workers.dev/";
const RESPONDERS_URL = "Responders.json";
const CONFIG_URL  = "config.json";
const ORG_URL     = "organization.json";

/* ===== Schedules ===== */
const SCHEDULE_OPTIONS = [
  { name:"ON-SITE",         code:"ONS",  abbr:"ONS", color:"ffffff" },
  { name:"OFFICE",          code:"OFC",  abbr:"OFC", color:"ffffff" },
  { name:"WORK FROM HOME",  code:"WFH",  abbr:"WFH", color:"b5e6a2" },
  { name:"VACATION LEAVE",  code:"VL",   abbr:"VL",  color:"f5c6ab" },
  { name:"AUTHORIZED ABSENT", code:"AA", abbr:"AA",  color:"ff0000" },
  { name:"PAID TIME OFF",   code:"PTO",  abbr:"PTO", color:"e87331" },
  { name:"BIRTHDAY LEAVE",  code:"BDL",  abbr:"BDL", color:"a02b93" },
  { name:"MATERNITY LEAVE", code:"ML",   abbr:"ML",  color:"f2ceef" },
  { name:"PATERNITY LEAVE", code:"PL",   abbr:"PL",  color:"0f9ed5" }
];
const SCHEDULE_GROUPS = [
  { title: "WORK SETUP",     codes: ["ONS","OFC","WFH"] },
  { title: "LEAVES",         codes: ["VL","AA"] },
  { title: "SPECIAL LEAVES", codes: ["PTO","BDL","ML","PL"] }
];
const LABELS = Object.fromEntries([
  ...SCHEDULE_OPTIONS.map(o => [o.code, o.abbr]),
  ['RD','RD'],
  ['HOL','HOL']
]);
const NAMES  = Object.fromEntries(SCHEDULE_OPTIONS.map(o => [o.code, o.name]));
const COLORS = Object.fromEntries([
  ...SCHEDULE_OPTIONS.map(o => [o.code, '#' + o.color.toLowerCase()]),
  ['RD',  '#808080'], // weekends
  ['HOL', '#ffff00']  // holidays
]);

/* ===== Helpers ===== */
const stripMeta = o => Object.fromEntries(Object.entries(o||{}).filter(([k]) => !k.startsWith("_")));
const pad = n => String(n).padStart(2,'0');
const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const parseYMD = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); };
const normVal = v => String(v ?? "").trim();
const uniq = arr => [...new Set(arr)];
function fmtMMMDDYYYY(d){const MMM=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];return `${MMM[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;}
function hexToRGB(hex){ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(c=>c+c).join(''); const n=parseInt(hex,16); return {r:(n>>16)&255, g:(n>>8)&255, b:(n&255)}; }
function getContrastText(hex){ const {r,g,b}=hexToRGB(hex); const yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128 ? 'text-black' : 'text-white'; }

/* ===== State ===== */
const state = {
  viewYear: new Date().getFullYear(),
  viewMonth: new Date().getMonth(),
  selected: new Set(),
  focusDay: ymd(new Date()),
  lastClicked: null,
  storeKey: 'calendar-scheduler-v2',
  data: {},
  isDashboard: false,
  typeMode: 'LEAVE' // default
};

/* ===== Config & Holidays ===== */
let CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
const parseDateStr = s => { if (!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };
const dateInRange = d => {
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return true;
  const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return dd >= CONFIG.START_DATE && dd <= CONFIG.END_DATE;
};
const isHoliday = d => CONFIG.HOLIDAYS_SET.has(ymd(d));
async function loadConfig(){
  try{
    const r = await fetch(CONFIG_URL);
    const j = await r.json();
    CONFIG.START_DATE  = parseDateStr(j.START_DATE);
    CONFIG.END_DATE    = parseDateStr(j.END_DATE);
    CONFIG.HOLIDAYS_SET = new Set(Array.isArray(j.HOLIDAYS) ? j.HOLIDAYS : []);
  }catch{
    CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
  }
}
function clampView(year, month) {
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return { year, month };
  const monthLast  = new Date(year, month+1, 0);
  if (monthLast < CONFIG.START_DATE) return { year: CONFIG.START_DATE.getFullYear(), month: CONFIG.START_DATE.getMonth() };
  const monthFirst = new Date(year, month, 1);
  if (monthFirst > CONFIG.END_DATE) return { year: CONFIG.END_DATE.getFullYear(), month: CONFIG.END_DATE.getMonth() };
  return { year, month };
}
function updateTitleFromConfig(){
  const el = document.getElementById('appTitle');
  if (!el) return;
  const s = CONFIG.START_DATE, e = CONFIG.END_DATE;
  el.textContent = (s && e) ? `Scheduler (${fmtMMMDDYYYY(s)} - ${fmtMMMDDYYYY(e)})` : "Scheduler";
}

/* ===== Organization ===== */
let ORG_INDEX = new Map();
let ORG_SUPERVISORS = []; // names that have TEAM

async function loadOrganization(){
  try{
    const r = await fetch(ORG_URL);
    const data = await r.json();

    ORG_INDEX.clear();
    ORG_SUPERVISORS = [];

    function indexOrg(node){
      if (!node || !node.NAME) return;
      ORG_INDEX.set(node.NAME, node);
      const team = Array.isArray(node.TEAM) ? node.TEAM : [];
      if (team.length > 0) ORG_SUPERVISORS.push(node.NAME);
      for (const child of team) indexOrg(child);
    }

    if (Array.isArray(data)) data.forEach(indexOrg);
    else if (data && typeof data === 'object' && data.MANAGER) indexOrg(data.MANAGER);
    else indexOrg(data);

    ORG_SUPERVISORS = Array.from(new Set(ORG_SUPERVISORS)).sort();
  }catch(e){
    console.error('loadOrganization error', e);
    ORG_INDEX.clear();
    ORG_SUPERVISORS = [];
  }
}

/* Returns all names under each selected supervisor (including the supervisor) */
function getSubtreeNames(supervisors){
  const out = new Set();
  function walk(node){
    if(!node || !node.NAME || out.has(node.NAME)) return;
    out.add(node.NAME);
    (node.TEAM||[]).forEach(walk);
  }
  supervisors.forEach(name=>{
    const node = ORG_INDEX.get(name);
    if (node) walk(node);
  });
  return [...out];
}

/* ===== Responders ===== */
let RESPONDERS = [];
async function loadResponders(){
  try{
    const res = await fetch(RESPONDERS_URL);
    const raw = await res.json();
    const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.rows) ? raw.rows : []);
    RESPONDERS = rows.map(r => ({
      POSITION:   normVal(r.POSITION   ?? r.position),
      TEAM:       normVal(r.TEAM       ?? r.team),
      NAME:       normVal(r.NAME       ?? r.name)
    })).filter(r => r.NAME);
  }catch(e){
    console.error("Failed to load responders:", e);
  }
}
function getAllNames(){ return uniq(RESPONDERS.map(r => r.NAME).filter(Boolean)).sort(); }
function getAllPositions(){ return uniq(RESPONDERS.map(r => r.POSITION || 'Unspecified')).sort(); }

/* ===== Local store ===== */
function loadStore(){
  try{ const raw = localStorage.getItem(state.storeKey); state.data = raw? JSON.parse(raw) : {}; }
  catch(e){ state.data = {}; }
}
function saveStore(){ localStorage.setItem(state.storeKey, JSON.stringify(state.data)); }

/* ===== Calendar UI ===== */
const grid = document.getElementById('calendarGrid');
const monthLabel = document.getElementById('monthLabel');
const selectedCount = document.getElementById('selectedCount');
const selectedList = document.getElementById('selectedList');

function monthName(m){return new Date(2000,m,1).toLocaleString(undefined,{month:'long'})}
function render(){
  const {viewYear, viewMonth} = state;
  monthLabel.textContent = `${monthName(viewMonth)} ${viewYear}`;
  renderGrid(viewYear, viewMonth);
  renderSelection();
}
function renderGrid(year, month){
  grid.innerHTML='';
  const first = new Date(year, month, 1);
  const last  = new Date(year, month+1, 0);
  const startWeekday = first.getDay();
  const prevLast = new Date(year, month, 0).getDate();

  for(let i=startWeekday-1; i>=0; i--) grid.appendChild(dayCell(new Date(year, month-1, prevLast - i), true));
  for(let d=1; d<=last.getDate(); d++) grid.appendChild(dayCell(new Date(year, month, d), false));
  const remaining = (7 - (grid.children.length % 7)) % 7;
  for(let i=1;i<=remaining;i++) grid.appendChild(dayCell(new Date(year, month+1, i), true));
}

function dayCell(dateObj, muted=false){
  const id = ymd(dateObj);
  const isToday   = id === ymd(new Date());
  const wd        = dateObj.getDay();
  const weekend   = (wd===0 || wd===6);
  const outRange  = !dateInRange(dateObj);
  const holiday   = isHoliday(dateObj);
  const isSelected= state.selected.has(id);
	const status = state.data[id] || '';
	// RD/HOL override individual schedule for display
	const effective = holiday ? 'HOL' : (weekend ? 'RD' : status);

	let bg = '';
	if (effective) bg = COLORS[effective];


  const disabled = outRange || holiday || weekend;

  const cell = document.createElement('button');
  cell.type='button';
  cell.className = [
    'day-cell aspect-square rounded-xl border border-slate-700 p-2 text-left transition',
    muted ? 'muted' : '',
    isSelected ? 'selected-day' : '',
    disabled ? 'cursor-not-allowed' : 'hover:border-blue-300'
  ].join(' ').trim();

  cell.dataset.date = id;
  if (bg) cell.style.background = bg;

  let textColor = 'white';
  if (bg) {
    const contrast = getContrastText(bg);
    textColor = (contrast === 'text-black') ? 'black' : 'white';
  }

	const badgeText = effective ? (LABELS[effective] || effective) : '';


  const badge = badgeText
    ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-black/10 border border-black/10" style="color:${textColor}">${badgeText}</span>`
    : '';

  cell.innerHTML = `
    <div class="flex items-center justify-between">
      <span class="w-7 h-7 rounded-full grid place-items-center ${isToday?'today-ring':''}"
            style="color:${textColor}">${dateObj.getDate()}</span>
    </div>
    <div class="mt-1 overflow-hidden">${badge}</div>
  `;

  cell.addEventListener('click', e => {
    if (disabled) return;
    onDayClick(id, e.shiftKey);
  });
  return cell;
}

function onDayClick(id, shift) {
  const date = parseYMD(id);
  const wd = date.getDay();
  if (!dateInRange(date)) return;
  if (isHoliday(date))    return;
  if (wd === 0 || wd === 6) return;

  if (shift && state.lastClicked) {
    const a = parseYMD(state.lastClicked), b = parseYMD(id);
    const [min, max] = a <= b ? [a, b] : [b, a];
    const cur = new Date(min);
    while (cur <= max) {
      const w = cur.getDay();
      if (dateInRange(cur) && !isHoliday(cur) && w !== 0 && w !== 6) {
        state.selected.add(ymd(cur));
      }
      cur.setDate(cur.getDate() + 1);
    }
  } else {
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
    state.lastClicked = id;
  }
  state.focusDay = id;
  render();
}
function renderSelection(){
  const items = Array.from(state.selected).sort();
  selectedCount.textContent = items.length? `${items.length} day(s) selected` : 'No days selected';
  selectedList.innerHTML = items.length
    ? `<div class="flex flex-wrap gap-2">${items.map(d=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-700">${d} ‚Äî ${state.data[d]? LABELS[state.data[d]] : '‚Äî'}</span>`).join('')}</div>`
    : '<p class="text-xs text-slate-500">Click weekdays (non-holiday) to select.</p>';
}

/* ===== Dynamic schedule controls (GROUPED) ===== */
function buildScheduleButtons(){
  const wrap = document.getElementById('schedButtons');
  wrap.innerHTML = '';

  SCHEDULE_GROUPS.forEach(group => {
    const block = document.createElement('div');
    block.className = 'rounded-xl border border-slate-800 p-3 bg-slate-900/40';

    const title = document.createElement('div');
    title.className = 'text-xs text-slate-400 mb-2';
    title.textContent = group.title;
    block.appendChild(title);

    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 gap-2';

    group.codes.forEach(code => {
      const opt = SCHEDULE_OPTIONS.find(o => o.code === code);
      if (!opt) return;
      const color = '#' + opt.color.toLowerCase();
      const textClass = getContrastText(color);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `w-full px-3 py-2 rounded-xl font-medium shadow-sm hover:opacity-95 ${textClass}`;
      btn.style.background = color;
      btn.textContent = opt.name;
      btn.addEventListener('click', () => applyType(opt.code));
      grid.appendChild(btn);
    });

    block.appendChild(grid);
    wrap.appendChild(block);
  });
}

/* ===== Apply / Clear ===== */
document.getElementById('clearSelectionBtn').onclick = ()=>{ state.selected.clear(); render(); };
const deleteBtn = document.getElementById('deleteBtn');
deleteBtn.onclick = ()=>{
  if(!(state.selected.size || state.focusDay)) return;
  if(!confirm('Clear status from the selected day(s)?')) return;
  const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
  for(const d of targets){ delete state.data[d]; }
  saveStore(); render();
};
function applyType(val){
  const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
  for(const d of targets){
    const dt = parseYMD(d);
    const wd = dt.getDay();
    if (!dateInRange(dt)) continue;
    if (isHoliday(dt))    continue;
    if (wd === 0 || wd === 6) continue;
    state.data[d] = val;
  }
  saveStore(); state.selected.clear(); render();
}

/* ===== Personnel filters (Team/Position/Name) ===== */
function fillSelect(sel, values, selected, blankLabel = "‚Äî select ‚Äî") {
  sel.innerHTML =
    `<option value="">${blankLabel}</option>` +
    (values.length
      ? values.map(v => `<option value="${v}">${v}</option>`).join("")
      : `<option value="" disabled>‚Äî none ‚Äî</option>`);
  if (selected !== undefined) sel.value = selected;
}
function setSaveEnabled(enabled) {
  ['loadBtn','exportBtn'].forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-60', !enabled);
    btn.classList.toggle('cursor-not-allowed', !enabled);
  });
}
function populateRespondersUI(changed = null) {
  const teamSel = document.getElementById("selTeam");
  const posSel  = document.getElementById("selPosition");
  const nameSel = document.getElementById("selName");

  let cur = {
    TEAM:     normVal(teamSel?.value),
    POSITION: normVal(posSel?.value),
    NAME:     normVal(nameSel?.value),
  };

  if (changed === "TEAM")     { cur.POSITION = ""; cur.NAME = ""; }
  if (changed === "POSITION") { cur.NAME = ""; }

  const all = RESPONDERS;
  const uniqVals = (arr, field) => uniq(arr.map(r => normVal(r[field]))).sort();

  const teamValues = uniqVals(all, "TEAM");
  if (cur.TEAM && !teamValues.includes(cur.TEAM)) cur.TEAM = "";
  fillSelect(teamSel, teamValues, cur.TEAM, "‚Äî all teams ‚Äî");

  const scopeTeam = cur.TEAM ? all.filter(r => normVal(r.TEAM) === cur.TEAM) : all;
  const posValues = uniqVals(scopeTeam, "POSITION");
  if (cur.POSITION && !posValues.includes(cur.POSITION)) cur.POSITION = "";
  fillSelect(posSel, posValues, cur.POSITION, "‚Äî all positions ‚Äî");

  let scopeForNames = scopeTeam;
  if (cur.POSITION) scopeForNames = scopeForNames.filter(r => normVal(r.POSITION) === cur.POSITION);
  const nameValues = uniq(scopeForNames.map(r => normVal(r.NAME))).sort();
  if (cur.NAME && !nameValues.includes(cur.NAME)) cur.NAME = "";
  fillSelect(nameSel, nameValues, cur.NAME, "‚Äî select name ‚Äî");

  if (!cur.NAME) {
    state.data = {};
    saveStore();
    render();
  }

  localStorage.setItem("responders-filters", JSON.stringify(cur));
  setSaveEnabled(!!cur.NAME);
  updateDashToggleEligibility();
}
function wireResponderEvents() {
  const teamSel = document.getElementById("selTeam");
  const posSel  = document.getElementById("selPosition");
  const nameSel = document.getElementById("selName");

  teamSel?.addEventListener("change", () => { populateRespondersUI("TEAM"); });
  posSel?.addEventListener("change",   () => { populateRespondersUI("POSITION"); });
  nameSel?.addEventListener("change", async (e) => {
    populateRespondersUI("NAME");
    updateDashToggleEligibility();
    const name = (e.target?.value || "").trim();
    if (name) await loadScheduleForName(name);
    else setSaveEnabled(false);
  });
}

/* ===== Save via Worker (includes preset HOL & RD) ===== */
async function uploadScheduleViaProxy(){
  const exportBtn = document.getElementById('exportBtn');
  const selName = document.getElementById('selName');
  const selTeam = document.getElementById('selTeam');
  const selPosition = document.getElementById('selPosition');

  const name = (selName.value || '').trim();
  if(!name){ alert("Pick a Name first."); selName.focus(); return; }

  if(Object.keys(state.data).length === 0){
    if(!confirm("Your schedule is empty. Save anyway?")) return;
  }

  exportBtn.disabled = true;
  const prevText = exportBtn.textContent;
  exportBtn.textContent = "Saving‚Ä¶";

  const mergedData = { ...state.data };
  const d = new Date(CONFIG.START_DATE);
  while (d <= CONFIG.END_DATE) {
    const id = ymd(d);
    const wd = d.getDay();
	if (isHoliday(d)) {
	  mergedData[id] = 'HOL';           // always override to HOL
	} else if (wd === 0 || wd === 6) {
	  mergedData[id] = 'RD';            // always override to RD
	}
    d.setDate(d.getDate() + 1);
  }

  const payload = {
    op: "save",
    name,
    data: {
      ...mergedData,
      _meta: {
        team: selTeam.value,
        position: selPosition.value,
        name,
        lastSaved: new Date().toISOString()
      }
    }
  };

  try{
    const res = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify(payload),
    });

    let j = null;
    try { j = await res.json(); } catch {}
    if (!res.ok || !j?.ok) {
      const err = (j && (j.error || j.message)) || `HTTP ${res.status}`;
      throw new Error(err);
    }

    alert(`Saved ‚úÖ`);
  } catch(e){
    alert("Save failed:\n" + (e?.message || e));
  } finally {
    exportBtn.disabled = false;
    exportBtn.textContent = prevText;
  }
}
document.getElementById('exportBtn').onclick = uploadScheduleViaProxy;

/* ===== Load schedule (personnel) ===== */
async function loadScheduleForName(name) {
  const loadBtn = document.getElementById('loadBtn');
  const hasName = !!(name && name.trim());
  setSaveEnabled(hasName);

  state.data = {};
  saveStore();
  render();
  if (!hasName) return;

  const prevText = loadBtn ? loadBtn.textContent : '';
  if (loadBtn) { loadBtn.textContent = "Loading‚Ä¶"; loadBtn.disabled = true; }

  try {
    const r = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ op: "load", name })
    });
    const j = await r.json();

    if (j?.ok && j.data) {
      const loaded = stripMeta(j.data);
      const valid = {};
      for (const [k, v] of Object.entries(loaded)) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(k) && typeof v === "string") valid[k] = v;
      }
      state.data = valid;
      saveStore();
      render();
    } else {
      render();
    }
  } catch (e) {
    console.error("Worker load error:", e);
  } finally {
    if (loadBtn) { loadBtn.textContent = prevText || "Refresh"; loadBtn.disabled = !hasName; }
  }
}
document.getElementById('loadBtn').onclick = async () => {
  const selName = document.getElementById('selName');
  const name = (selName.value || '').trim();
  if (!name) { alert("Pick a Name first."); selName.focus(); return; }
  await loadScheduleForName(name);
};

/* ===== Export helpers (used by dashboard too if needed) ===== */
function dateRangeList() {
  const out = [];
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return out;
  const d = new Date(CONFIG.START_DATE);
  while (d <= CONFIG.END_DATE) {
    out.push(ymd(d));
    d.setDate(d.getDate() + 1);
  }
  return out;
}
async function fetchScheduleData(name){
  try{
    const r = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ op: "load", name })
    });
    const j = await r.json();
    if (j?.ok && j.data) return stripMeta(j.data);
  }catch(e){
    console.warn("Fetch schedule failed for", name, e);
  }
  return {};
}
/* ===== Download helper ===== */
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* ===== Ensure XLSX (SheetJS) present ===== */
async function ensureXLSX(){
  if (window.XLSX) return;
  const urls = [
    "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"
  ];
  for (const url of urls) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url; s.async = true;
        s.onload = resolve; s.onerror = () => reject(new Error("failed"));
        document.head.appendChild(s);
      });
      if (window.XLSX) return;
    } catch {}
  }
  throw new Error("Failed to load SheetJS (XLSX).");
}

/* ===== Export menu wiring ===== */
const exportFileBtn  = document.getElementById('exportFileBtn');
const exportMenu     = document.getElementById('exportMenu');
const exportVlBtn    = document.getElementById('exportVlBtn');
const exportTableBtn = document.getElementById('exportTableBtn');

function toggleMenu(show){ exportMenu.classList.toggle('hidden', !show); }
if (exportFileBtn) exportFileBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  const isHidden = exportMenu.classList.contains('hidden');
  toggleMenu(isHidden);
});
document.addEventListener('click', ()=> toggleMenu(false));

/* ===== VL Summary (.txt) ===== */
async function exportVlSummary(){
  const names = getFilteredNamesForDashboard();
  if (!names.length) { alert("No names match the current filter."); return; }

  const pairs = await Promise.all(names.map(async n => [n, await fetchScheduleData(n)]));
  const lines = [];

  for (const [name, data] of pairs) {
    lines.push(name);
    const vlDates = Object.entries(data || {})
      .filter(([k, v]) => v === 'VL' && dateInRange(parseYMD(k)))
      .map(([k]) => parseYMD(k))
      .sort((a,b)=>a-b);

    if (!vlDates.length) { lines.push("(no VL)"); lines.push(""); continue; }

    const groups = {};
    for (const d of vlDates) {
      const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      (groups[key] ||= []).push(d);
    }
    const keys = Object.keys(groups).sort();
    for (const key of keys) {
      const arr = groups[key];
      const label = arr[0].toLocaleString(undefined, { month:'long', year:'numeric' });
      const days = arr.map(d => d.getDate()).join(", ");
      lines.push(label);
      lines.push(days);
    }
    lines.push("");
  }

  const fname = `VL_Summary_${new Date().toISOString().slice(0,10)}.txt`;
  downloadBlob(lines.join("\n"), fname, "text/plain;charset=utf-8");
}

/* ===== Table (.xlsx) ===== */
async function exportTableXlsx(){
  await ensureXLSX();
  const names = getFilteredNamesForDashboard();
  if (!names.length) { alert("No names match the current filter."); return; }

  const dates = dateRangeList();
  if (!dates.length) { alert("Config START_DATE/END_DATE missing."); return; }

  const schedules = await Promise.all(names.map(async n => [n, await fetchScheduleData(n)]));

  const header = ["Name", ...dates];
  const rows = [header];
  const statusToCell = (code) => (code ? (LABELS[code] ?? code) : "");

  for (const [name, data] of schedules) {
    const row = [name];
    for (const d of dates) row.push(statusToCell(data?.[d] || ""));
    rows.push(row);
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!freeze"] = { xSplit: 1, ySplit: 1 };
  ws["!cols"] = [{ wch: 28 }, ...dates.map(() => ({ wch: 10 }))];
  XLSX.utils.book_append_sheet(wb, ws, "Schedule");

  const ts = new Date().toISOString().slice(0,10).replaceAll("-","");
  XLSX.writeFile(wb, `TeamSchedule_Table_${ts}.xlsx`);
}

if (exportVlBtn)    exportVlBtn.addEventListener('click', async ()=>{ toggleMenu(false); await exportVlSummary(); });
if (exportTableBtn) exportTableBtn.addEventListener('click', async ()=>{ toggleMenu(false); await exportTableXlsx(); });


/* ===== Navigation ===== */
document.getElementById('prevBtn').onclick = ()=>{
  const d = new Date(state.viewYear, state.viewMonth - 1, 1);
  ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
  render();
};
document.getElementById('nextBtn').onclick = ()=>{
  const d = new Date(state.viewYear, state.viewMonth + 1, 1);
  ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
  render();
};

/* ===== Dashboard view & filters ===== */
const $toggleDash = document.getElementById('toggleDashboardBtn');
const $filtersWrap = document.getElementById('filtersWrap');
const $personnelView = document.getElementById('personnelView');
const $dashboardView = document.getElementById('dashboardView');
const $loadBtn = document.getElementById('loadBtn');
const $saveBtn = document.getElementById('exportBtn');
const $exportGroup = document.getElementById('exportGroup');

const $fSupervisors = document.getElementById('fSupervisors');
const $metricTotal  = document.getElementById('metricTotalVl');
const $centerTable  = document.getElementById('centerTable');
const $hint         = document.getElementById('dashboardHint');
const $currentTypeCaption = document.getElementById('currentTypeCaption');
const $missingList  = document.getElementById('missingList');
const $missingSubtitle = document.getElementById('missingSubtitle');

/* Eligibility (Manager / Deputy / Senior) */
const DASH_ALLOWED_POS = new Set(['senior gis specialist','deputy manager','manager']);
function getSelectedResponderPositionLower() {
  const nameSel = document.getElementById('selName');
  const name = (nameSel?.value || '').trim();
  if (!name) return null;
  const r = RESPONDERS.find(x => (x.NAME || '') === name);
  return (r?.POSITION ?? '').trim().toLowerCase() || null;
}
function isDashboardEligible() {
  const pos = getSelectedResponderPositionLower();
  return !!pos && DASH_ALLOWED_POS.has(pos);
}
function setDashToggleDisabled(disabled) {
  const btn = document.getElementById('toggleDashboardBtn');
  if (!btn) return;
  btn.disabled = !!disabled;
  btn.classList.toggle('cursor-default', !!disabled);
  btn.classList.toggle('pointer-events-none', !!disabled);
  btn.title = disabled ? '' : (state.isDashboard ? 'Switch to Personnel View' : 'Switch to Dashboard View');
}
function updateDashToggleEligibility(){
  if (state.isDashboard) { setDashToggleDisabled(false); return; }
  setDashToggleDisabled(!isDashboardEligible());
}

/* ---- WORK/LEAVE mode ---- */
const WORK_CODES  = ['ONS','WFH','OFC'];
const LEAVE_CODES = ['VL','AA','PTO','PL','ML','BDL'];
function getSelectedTypeCodes(){ return state.typeMode === 'WORK' ? WORK_CODES : LEAVE_CODES; }
function renderTypeSwitch(){
  const $work  = document.getElementById('btnWork');
  const $leave = document.getElementById('btnLeave');
  const $hint  = document.getElementById('typeSwitchHint');

  const active   = 'text-[#0a0f1a] font-semibold border border-slate-500';
  const inactive = 'bg-slate-800 text-slate-200 border border-slate-700 hover:bg-slate-700/60';

  // Reset both buttons first
  [$work,$leave].forEach(el=>{
    el.className = 'px-3 py-1.5 text-sm rounded-none transition-colors ' + inactive;
    el.style.backgroundColor = ''; // clear inline bg
  });

  if(state.typeMode === 'WORK'){
    $work.className = 'px-3 py-1.5 text-sm rounded-none transition-colors ' + active;
    $work.style.backgroundColor = '#fcfcfc';
    $hint.textContent = 'Showing: ON-SITE, WORK FROM HOME, OFFICE';
  } else {
    $leave.className = 'px-3 py-1.5 text-sm rounded-none transition-colors ' + active;
    $leave.style.backgroundColor = '#fcfcfc';
    $hint.textContent = 'Showing: VACATION LEAVE, AUTHORIZED ABSENT, PTO, PATERNITY, MATERNITY, BIRTHDAY';
  }
}
document.getElementById('btnWork').onclick = ()=>{ if(state.typeMode!=='WORK'){ state.typeMode='WORK'; renderTypeSwitch(); buildDashboard(); } };
document.getElementById('btnLeave').onclick= ()=>{ if(state.typeMode!=='LEAVE'){ state.typeMode='LEAVE'; renderTypeSwitch(); buildDashboard(); } };

/* Completeness (strict) */
function isWeekend(d){ const w=d.getDay(); return w===0||w===6; }
function hasCompleteScheduleForRangeStrict(dataObj){
  if(!CONFIG.START_DATE||!CONFIG.END_DATE) return false;
  const d=new Date(CONFIG.START_DATE);
  while(d<=CONFIG.END_DATE){
    const id=ymd(d);
    const v=dataObj?.[id];
    if(isHoliday(d)){ if(v!=='HOL') return false; }
    else if(isWeekend(d)){ if(v!=='RD') return false; }
    else { if(!v) return false; }
    d.setDate(d.getDate()+1);
  }
  return true;
}

/* Dashboard filter helper */
function getFilteredNamesForDashboard() {
  if (!state.isDashboard) return getAllNames().sort();
  const val = $fSupervisors.value || '__ALL__';
  return (val==='__ALL__') ? getAllNames() : getSubtreeNames([val]);
}

/* Toggle handler */
$toggleDash.addEventListener('click', async () => {
  if (!state.isDashboard && !isDashboardEligible()) return;

  state.isDashboard = !state.isDashboard;
  if (state.isDashboard) {
    enterDashboard();
    await prepareDashboardFilters();
    renderTypeSwitch();
    await autoApplySupervisorFromName();
    await buildDashboard();
  } else {
    exitDashboard();
  }
});
function enterDashboard(){
  $filtersWrap.classList.add('hidden');
  $loadBtn.classList.add('hidden');
  $saveBtn.classList.add('hidden');
  $personnelView.classList.add('hidden');
  $dashboardView.classList.remove('hidden');
  document.getElementById('dashIcon').textContent = 'üë•';
  $exportGroup.classList.remove('hidden');
  setDashToggleDisabled(false);
}

function exitDashboard(){
  $filtersWrap.classList.remove('hidden');
  $loadBtn.classList.remove('hidden');
  $saveBtn.classList.remove('hidden');
  $dashboardView.classList.add('hidden');
  $personnelView.classList.remove('hidden');
  document.getElementById('dashIcon').textContent = 'üóìÔ∏è';
  $exportGroup.classList.add('hidden');
  updateDashToggleEligibility();
}


/* Populate supervisors with -ALL- (single select) */
async function prepareDashboardFilters(){
  const supList = ORG_SUPERVISORS.slice().sort();
  $fSupervisors.innerHTML = `<option value="__ALL__">-ALL-</option>` + supList.map(n => `<option>${n}</option>`).join('');
  $fSupervisors.onchange   = buildDashboard;
}

/* Auto-select current user as supervisor if applicable */
async function autoApplySupervisorFromName(){
  const nameSel = document.getElementById('selName');
  const chosen = (nameSel?.value || '').trim();
  if (!chosen || !$fSupervisors) return;

  const opts = Array.from($fSupervisors.options);
  const idx = opts.findIndex(o => (o.value || o.textContent).trim() === chosen);
  if (idx >= 0) {
    $fSupervisors.selectedIndex = idx;
  }
}

/* Build dashboard (date ‚Üí aggregate by code, list names) */
async function buildDashboard(){
  $hint.textContent = 'Loading‚Ä¶';
  $centerTable.innerHTML = '';
  $missingList.innerHTML = '';

  const selectedTypes = getSelectedTypeCodes();
  $currentTypeCaption.textContent = selectedTypes.length
    ? `Types: ${selectedTypes.map(c=>NAMES[c]||c).join(', ')}`
    : 'Types: (none)';

  const val = $fSupervisors.value || '__ALL__';
  const allowedNames = (val==='__ALL__') ? getAllNames() : getSubtreeNames([val]);

  // fetch all schedules
  const dates = dateRangeList();
  const dateSet = new Set(dates);
  const pairs = await Promise.all(allowedNames.map(async n => [n, await fetchScheduleData(n)]));

  // Aggregate by date -> [{name, code}]
  const dateToPeople = new Map();
  let totalRecords = 0;
  for (const [name, sched] of pairs) {
    for (const [d, code] of Object.entries(sched || {})) {
      if (!dateSet.has(d)) continue;
      if (!selectedTypes.includes(code)) continue;
      if (!dateToPeople.has(d)) dateToPeople.set(d, []);
      dateToPeople.get(d).push({ name, code });
      totalRecords++;
    }
  }
  $metricTotal.textContent = String(totalRecords);

  // Build center table:
  // DATE, COUNT, [TYPES...]
  // then lines: (empty date/count), CODE: names...
  let html = '<thead><tr>';
  html += '<th class="text-left">Date</th>';
  html += '<th class="text-left">Count</th>';
  html += '<th class="text-left">Details</th>';
  html += '</tr></thead><tbody>';

  const rows = Array.from(dateToPeople.entries())
    .map(([d, people]) => [d, people.slice().sort((a,b)=> a.name.localeCompare(b.name))])
    .sort((a,b)=>(a[0] < b[0] ? -1 : 1));

  for (const [d, people] of rows) {
    const byCode = {};
    for (const p of people) (byCode[p.code] ||= []).push(p.name);
    const codes = Object.keys(byCode).sort();

    // header row per date
    html += `<tr>
      <td class="whitespace-nowrap">${new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}</td>
      <td>${people.length}</td>
      <td class="text-slate-300">[ ${codes.join(', ')} ]</td>
    </tr>`;

    // detail rows per code
    for (const c of codes) {
      html += `<tr>
        <td></td>
        <td></td>
        <td class="text-slate-300"><span class="font-semibold">${c}:</span> ${byCode[c].join(', ')}</td>
      </tr>`;
    }
  }
  html += '</tbody>';
  $centerTable.innerHTML = rows.length ? html : '<tbody><tr><td class="text-slate-400">No data for selected filters/types.</td></tr></tbody>';

  // Incomplete list (strict) ‚Äî only filtered by supervisor
  const nameToData = new Map(pairs.map(([n,d])=>[n,d||{}]));
  const incomplete = allowedNames.filter(n=>!hasCompleteScheduleForRangeStrict(nameToData.get(n))).sort((a,b)=>a.localeCompare(b));

  if(!incomplete.length){
    $missingList.innerHTML=`<div class="text-slate-400 text-sm">Everyone under the selected supervisor has a complete schedule for the range.</div>`;
  }else{
    // position lookup
    const posMap = new Map(RESPONDERS.map(r => [r.NAME, r.POSITION || 'Unspecified']));
    $missingList.innerHTML=incomplete.map(n=>{
      const pos=posMap.get(n)||'Unspecified';
      return `<div class="flex items-start gap-2">
        <span class="w-2 h-2 mt-2 rounded-full bg-yellow-500/80"></span>
        <div><div class="font-medium">${n}</div><div class="text-xs text-slate-400">${pos}</div></div>
      </div>`;
    }).join('');
  }
  $missingSubtitle.textContent =
    `Under: ${val==='__ALL__'?'All supervisors':val} ‚Ä¢ Completeness: HOL on holidays, RD on weekends, any set on weekdays`;

  $hint.textContent = rows.length ? 'Showing selected schedule types per day.' : 'Adjust supervisor or schedule mode.';
}

/* ===== Init ===== */
(async () => {
  loadStore();
  await loadConfig();
  updateTitleFromConfig();
  await loadResponders();
  await loadOrganization();

  // GROUPED schedule controls
  buildScheduleButtons();

  // Personnel filters
  populateRespondersUI();
  wireResponderEvents();
  setSaveEnabled(false);
  ({year: state.viewYear, month: state.viewMonth} = clampView(state.viewYear, state.viewMonth));
  render();

  // Dashboard eligibility
  updateDashToggleEligibility();
})();
</script>
</body>
</html>
