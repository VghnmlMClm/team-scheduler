<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#2563eb}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .day-cell{user-select:none}
    .selected-day{outline:2px solid var(--brand); outline-offset:-2px}
    .today-ring{box-shadow:inset 0 0 0 2px var(--brand)}
    .muted{opacity:.35}
    .grad{background:linear-gradient(135deg,#1d4ed8 0%,#06b6d4 100%)}
  </style>
</head>

<body class="bg-black text-slate-100">
<header class="grad text-white">
  <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col gap-4">
    <!-- Title + Actions -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-white/15 grid place-items-center"><span class="text-lg">üóìÔ∏è</span></div>
        <h1 class="text-xl sm:text-2xl font-semibold">Scheduler</h1>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="loadBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition opacity-60 cursor-not-allowed">Load</button>
        <button id="exportBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition opacity-60 cursor-not-allowed">Save</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 gap-2">
      <!-- Line 1 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <select id="selDivision"   class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading divisions‚Ä¶</option>
        </select>
        <select id="selDepartment" class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading departments‚Ä¶</option>
        </select>
        <select id="selTeam"       class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading teams‚Ä¶</option>
        </select>
      </div>
      <!-- Line 2 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <select id="selPosition"   class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading positions‚Ä¶</option>
        </select>
        <select id="selName"       class="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white outline-none focus:ring-2 focus:ring-white/40">
          <option value="">Loading names‚Ä¶</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Calendar -->
  <section class="lg:col-span-2 bg-slate-900 text-slate-100 rounded-2xl shadow-sm border border-slate-800">
    <div class="p-4 flex items-center justify-between gap-2 border-b border-slate-700">
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Previous month">‚óÄ</button>
        <button id="todayBtn" class="px-3 py-2 rounded-lg bg-blue-700 text-white hover:opacity-95">Today</button>
        <button id="nextBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Next month">‚ñ∂</button>
      </div>
      <div class="text-center">
        <h2 id="monthLabel" class="text-lg font-semibold"></h2>
        <p id="selectedCount" class="text-xs text-slate-400"></p>
      </div>
      <div class="flex items-center gap-2">
        <button id="clearSelectionBtn" class="px-3 py-2 rounded-lg border border-slate-600 hover:bg-slate-800">Clear selection</button>
      </div>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-7 text-xs font-medium text-slate-400 mb-2 select-none">
        <div class="text-center">Sun</div>
        <div class="text-center">Mon</div>
        <div class="text-center">Tue</div>
        <div class="text-center">Wed</div>
        <div class="text-center">Thu</div>
        <div class="text-center">Fri</div>
        <div class="text-center">Sat</div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>
  </section>

  <!-- Sidebar -->
  <aside class="bg-slate-900 text-slate-100 rounded-2xl shadow-sm border border-slate-800 overflow-hidden">
    <div class="p-4 border-b border-slate-700">
      <h3 class="text-lg font-semibold">Set schedule for selected day(s)</h3>
      <p class="text-xs text-slate-400">Only these types are allowed. Weekends & holidays cannot be edited.</p>
    </div>
    <form id="eventForm" class="p-4 space-y-4" onsubmit="return false;">
      <div class="space-y-3">
        <label class="text-xs text-slate-400">Quick set status</label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <button id="btnVL" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#ed7d31">Vacation Leave</button>
          <button id="btnWFH" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#92d050">Work From Home</button>
          <button id="btnONSITE" type="button" class="px-3 py-2 rounded-xl text-white font-medium shadow-sm hover:opacity-95" style="background:#548235">On-site</button>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="deleteBtn" class="px-4 py-2 rounded-xl border border-slate-600 hover:bg-slate-800" type="button">Clear status on selected</button>
      </div>
    </form>
    <div class="px-4 pb-4">
      <h4 class="mt-2 mb-1 text-sm font-semibold">Selected:</h4>
      <div id="selectedList" class="text-sm text-slate-400"></div>
      <h4 class="mt-4 mb-1 text-sm font-semibold">Legend</h4>
      <div class="text-sm space-y-1">
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#ed7d31"></span> Vacation Leave</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#548235"></span> On-site</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#92d050"></span> Work From Home</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#BFBFBF"></span> Weekend (no status)</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 inline-block rounded" style="background:#00b0f0"></span> Holiday</div>
      </div>
    </div>
  </aside>
</main>

<footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
  <p>Tip: Hold <kbd class="px-1 rounded bg-slate-700 text-white">Shift</kbd> and click to select a range.</p>
</footer>

<!-- ====== SCRIPT ====== -->
<script>
  // URLs
  const SCHEDULE_BASE_URL = "https://raw.githubusercontent.com/VghnmlMClm/team-scheduler/main/schedules/";
  const PROXY_URL = "https://frosty-water-9f6a.voughn-calma-086.workers.dev/";
  const RESPONDERS_URL = "Responders.json";
  const CONFIG_URL = "config.json";

  // Helpers
  const safeFileName = name => name.trim().replace(/\s+/g, "_");
  const stripMeta = obj => Object.fromEntries(Object.entries(obj || {}).filter(([k]) => !k.startsWith("_")));
  const COLORS = { VL:'#ed7d31', ONSITE:'#548235', WFH:'#92d050', WEEKEND:'#BFBFBF' };
  const LABELS = { VL:'VL', ONSITE:'SITE', WFH:'WFH' };
  const pad = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseYMD = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); };
  const normVal = v => String(v ?? "").trim();
  const uniq = arr => [...new Set(arr)];

  // State
  const state = {
    viewYear: new Date().getFullYear(),
    viewMonth: new Date().getMonth(),
    selected: new Set(),
    focusDay: ymd(new Date()),
    lastClicked: null,
    storeKey: 'calendar-scheduler-v2',
    data: {}
  };

  // Config (window & holidays)
  let CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
  const parseDateStr = s => { if (!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };
  const dateInRange = d => {
    if (!CONFIG.START_DATE || !CONFIG.END_DATE) return true;
    const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return dd >= CONFIG.START_DATE && dd <= CONFIG.END_DATE;
  };
  const isHoliday = d => CONFIG.HOLIDAYS_SET.has(ymd(d));
  async function loadConfig(){
    try{
      const r = await fetch(CONFIG_URL, { headers: { "Accept":"application/json" } });
      const j = await r.json();
      CONFIG.START_DATE  = parseDateStr(j.START_DATE);
      CONFIG.END_DATE    = parseDateStr(j.END_DATE);
      CONFIG.HOLIDAYS_SET = new Set(Array.isArray(j.HOLIDAYS) ? j.HOLIDAYS : []);
    }catch{
      CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
    }
  }
  function clampView(year, month) {
    if (!CONFIG.START_DATE || !CONFIG.END_DATE) return { year, month };
    const monthLast  = new Date(year, month+1, 0);
    if (monthLast < CONFIG.START_DATE) return { year: CONFIG.START_DATE.getFullYear(), month: CONFIG.START_DATE.getMonth() };
    const monthFirst = new Date(year, month, 1);
    if (monthFirst > CONFIG.END_DATE) return { year: CONFIG.END_DATE.getFullYear(), month: CONFIG.END_DATE.getMonth() };
    return { year, month };
  }

  // Responders & dropdowns
  let RESPONDERS = [];
  function fillSelect(sel, values, selected, blankLabel = "‚Äî select ‚Äî") {
    sel.innerHTML =
      `<option value="">${blankLabel}</option>` +
      (values.length
        ? values.map(v => `<option value="${v}">${v}</option>`).join("")
        : `<option value="" disabled>‚Äî none ‚Äî</option>`);
    if (selected !== undefined) sel.value = selected;
  }
  function setSaveEnabled(enabled) {
    ['loadBtn','exportBtn'].forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;
      btn.disabled = !enabled;
      btn.classList.toggle('opacity-60', !enabled);
      btn.classList.toggle('cursor-not-allowed', !enabled);
    });
  }
  function populateRespondersUI(changed = null) {
    const divSel  = document.getElementById("selDivision");
    const depSel  = document.getElementById("selDepartment");
    const teamSel = document.getElementById("selTeam");
    const posSel  = document.getElementById("selPosition");
    const nameSel = document.getElementById("selName");

    let cur = {
      DIVISION:  normVal(divSel.value),
      DEPARTMENT:normVal(depSel.value),
      TEAM:      normVal(teamSel.value),
      POSITION:  normVal(posSel.value),
      NAME:      normVal(nameSel.value),
    };

    if (changed === "DIVISION")   { cur.DEPARTMENT = ""; cur.TEAM = ""; cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "DEPARTMENT") { cur.TEAM = "";       cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "TEAM")       {                      cur.POSITION = ""; cur.NAME = ""; }
    if (changed === "POSITION")   {                                       cur.NAME = ""; }

    const all = RESPONDERS;

    const divValues = uniq(all.map(r => normVal(r.DIVISION))).sort();
    if (cur.DIVISION && !divValues.includes(cur.DIVISION)) cur.DIVISION = "";
    fillSelect(divSel, divValues, cur.DIVISION, "‚Äî select division ‚Äî");
    const scopeDiv = cur.DIVISION ? all.filter(r => normVal(r.DIVISION) === cur.DIVISION) : all;

    const depValues = uniq(scopeDiv.map(r => normVal(r.DEPARTMENT))).sort();
    if (cur.DEPARTMENT && !depValues.includes(cur.DEPARTMENT)) cur.DEPARTMENT = "";
    fillSelect(depSel, depValues, cur.DEPARTMENT, "‚Äî select department ‚Äî");
    const scopeDep = cur.DEPARTMENT ? scopeDiv.filter(r => normVal(r.DEPARTMENT) === cur.DEPARTMENT) : scopeDiv;

    const teamValues = uniq(scopeDep.map(r => normVal(r.TEAM))).sort();
    if (cur.TEAM && !teamValues.includes(cur.TEAM)) cur.TEAM = "";
    fillSelect(teamSel, teamValues, cur.TEAM, "‚Äî all teams ‚Äî");

    const scopeTeam = cur.TEAM ? scopeDep.filter(r => normVal(r.TEAM) === cur.TEAM) : scopeDep;
    const posValues = uniq(scopeTeam.map(r => normVal(r.POSITION))).sort();
    if (cur.POSITION && !posValues.includes(cur.POSITION)) cur.POSITION = "";
    fillSelect(posSel, posValues, cur.POSITION, "‚Äî all positions ‚Äî");

    let scopeForNames = scopeTeam;
    if (cur.POSITION) scopeForNames = scopeForNames.filter(r => normVal(r.POSITION) === cur.POSITION);
    const nameValues = uniq(scopeForNames.map(r => normVal(r.NAME))).sort();
    if (cur.NAME && !nameValues.includes(cur.NAME)) cur.NAME = "";
    fillSelect(nameSel, nameValues, cur.NAME, "‚Äî select name ‚Äî");

    if (!cur.NAME) {
      state.data = {};
      saveStore();
      render();
    }

    localStorage.setItem("responders-filters", JSON.stringify(cur));
    setSaveEnabled(!!cur.NAME);
  }
  async function loadResponders() {
    try{
      const res = await fetch(RESPONDERS_URL, { headers: { "Accept":"application/json" }});
      const raw = await res.json();
      const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.rows) ? raw.rows : []);
      RESPONDERS = rows.map(r => ({
        POSITION:   normVal(r.POSITION   ?? r.position),
        DIVISION:   normVal(r.DIVISION   ?? r.division),
        DEPARTMENT: normVal(r.DEPARTMENT ?? r.department),
        TEAM:       normVal(r.TEAM       ?? r.team),
        NAME:       normVal(r.NAME       ?? r.name)
      })).filter(r => r.NAME);
      populateRespondersUI();
    }catch(e){
      console.error("Failed to load responders:", e);
      ["selDivision","selDepartment","selTeam","selPosition","selName"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) { el.innerHTML = `<option>Error loading</option>`; el.disabled = true; }
      });
    }
  }
  function wireResponderEvents() {
    document.getElementById("selDivision").addEventListener("change", ()=> populateRespondersUI("DIVISION"));
    document.getElementById("selDepartment").addEventListener("change", ()=> populateRespondersUI("DEPARTMENT"));
    document.getElementById("selTeam").addEventListener("change", ()=> populateRespondersUI("TEAM"));
    document.getElementById("selPosition").addEventListener("change", ()=> populateRespondersUI("POSITION"));
    document.getElementById("selName").addEventListener("change", async (e) => {
      populateRespondersUI("NAME");
      await loadScheduleForName(e.target.value);
    });
  }

  // Local store
  function loadStore(){
    try{ const raw = localStorage.getItem(state.storeKey); state.data = raw? JSON.parse(raw) : {}; }
    catch(e){ state.data = {}; }
  }
  function saveStore(){ localStorage.setItem(state.storeKey, JSON.stringify(state.data)); }

  // Calendar render
  const grid = document.getElementById('calendarGrid');
  const monthLabel = document.getElementById('monthLabel');
  const selectedCount = document.getElementById('selectedCount');
  const selectedList = document.getElementById('selectedList');

  function monthName(m){return new Date(2000,m,1).toLocaleString(undefined,{month:'long'})}
  function render(){
    const {viewYear, viewMonth} = state;
    monthLabel.textContent = `${monthName(viewMonth)} ${viewYear}`;
    renderGrid(viewYear, viewMonth);
    renderSelection();
  }
  function renderGrid(year, month){
    grid.innerHTML='';
    const first = new Date(year, month, 1);
    const last  = new Date(year, month+1, 0);
    const startWeekday = first.getDay();
    const prevLast = new Date(year, month, 0).getDate();

    for(let i=startWeekday-1; i>=0; i--) grid.appendChild(dayCell(new Date(year, month-1, prevLast - i), true));
    for(let d=1; d<=last.getDate(); d++) grid.appendChild(dayCell(new Date(year, month, d), false));
    const remaining = (7 - (grid.children.length % 7)) % 7;
    for(let i=1;i<=remaining;i++) grid.appendChild(dayCell(new Date(year, month+1, i), true));
  }
  function dayCell(dateObj, muted=false){
    const id = ymd(dateObj);
    const isToday   = id === ymd(new Date());
    const wd        = dateObj.getDay();
    const weekend   = (wd===0 || wd===6);
    const outRange  = !dateInRange(dateObj);
    const holiday   = isHoliday(dateObj);
    const isSelected= state.selected.has(id);
    const status    = state.data[id] || '';

    let bg = '';
    if (status)       bg = COLORS[status];
    else if (holiday) bg = '#00b0f0';
    else if (weekend) bg = COLORS.WEEKEND;

    const disabled = outRange || holiday || weekend;

    const cell = document.createElement('button');
    cell.type='button';
    cell.className = [
      'day-cell aspect-square rounded-xl border border-slate-700 p-2 text-left transition',
      muted ? 'muted' : '',
      isSelected ? 'selected-day' : '',
      disabled ? 'cursor-not-allowed' : 'hover:border-blue-300'
    ].join(' ').trim();

    cell.dataset.date = id;
    if (bg) cell.style.background = bg;

    const badgeText = status ? LABELS[status] : (holiday ? 'HOL' : '');
    const badge = badgeText
      ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-black/10 border border-black/10">${badgeText}</span>`
      : '';

    cell.innerHTML = `
      <div class="flex items-center justify-between">
        <span class="w-7 h-7 rounded-full grid place-items-center ${isToday?'today-ring':''}">${dateObj.getDate()}</span>
      </div>
      <div class="mt-1 overflow-hidden">${badge}</div>
    `;

    cell.addEventListener('click', e => {
      if (disabled) return;
      onDayClick(id, e.shiftKey);
    });
    return cell;
  }

  function onDayClick(id, shift) {
    const date = parseYMD(id);
    const wd = date.getDay();
    if (!dateInRange(date)) return;
    if (isHoliday(date))    return;
    if (wd === 0 || wd === 6) return;

    if (shift && state.lastClicked) {
      const a = parseYMD(state.lastClicked), b = parseYMD(id);
      const [min, max] = a <= b ? [a, b] : [b, a];
      const cur = new Date(min);
      while (cur <= max) {
        const w = cur.getDay();
        if (dateInRange(cur) && !isHoliday(cur) && w !== 0 && w !== 6) {
          state.selected.add(ymd(cur));
        }
        cur.setDate(cur.getDate() + 1);
      }
    } else {
      if (state.selected.has(id)) state.selected.delete(id);
      else state.selected.add(id);
      state.lastClicked = id;
    }
    state.focusDay = id;
    render();
  }

  function renderSelection(){
    const items = Array.from(state.selected).sort();
    selectedCount.textContent = items.length? `${items.length} day(s) selected` : 'No days selected';
    selectedList.innerHTML = items.length
      ? `<div class="flex flex-wrap gap-2">${items.map(d=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-700">${d} ‚Äî ${state.data[d]? LABELS[state.data[d]] : '‚Äî'}</span>`).join('')}</div>`
      : '<p class="text-xs text-slate-500">Click dates to select them.</p>';
  }

  const deleteBtn = document.getElementById('deleteBtn');
  function applyType(val){
    const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
    for(const d of targets){
      const dt = parseYMD(d);
      const wd = dt.getDay();
      if (!dateInRange(dt)) continue;
      if (isHoliday(dt))    continue;
      if (wd === 0 || wd === 6) continue;
      state.data[d] = val;
    }
    saveStore(); state.selected.clear(); render();
  }
  document.getElementById('btnVL').onclick = ()=> applyType('VL');
  document.getElementById('btnWFH').onclick = ()=> applyType('WFH');
  document.getElementById('btnONSITE').onclick = ()=> applyType('ONSITE');

  deleteBtn.onclick = ()=>{
    if(!(state.selected.size || state.focusDay)) return;
    if(!confirm('Clear status from the selected day(s)?')) return;
    const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
    for(const d of targets){ delete state.data[d]; }
    saveStore(); render();
  };

  // Save (via proxy to GitHub)
  async function uploadScheduleViaProxy(){
    const exportBtn = document.getElementById('exportBtn');
    const selName = document.getElementById('selName');
    const selDivision = document.getElementById('selDivision');
    const selDepartment = document.getElementById('selDepartment');
    const selTeam = document.getElementById('selTeam');
    const selPosition = document.getElementById('selPosition');

    const name = (selName.value || '').trim();
    if(!name){ alert("Pick a Name first."); selName.focus(); return; }

    if(Object.keys(state.data).length === 0){
      if(!confirm("Your schedule is empty. Save anyway?")) return;
    }

    exportBtn.disabled = true;
    const prevText = exportBtn.textContent;
    exportBtn.textContent = "Saving‚Ä¶";

    const payload = {
      name,
      data: {
        ...state.data,
        _meta: {
          division: selDivision.value,
          department: selDepartment.value,
          team: selTeam.value,
          position: selPosition.value,
          name,
          lastSaved: new Date().toISOString()
        }
      }
    };

    try{
      const res = await fetch(PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(txt || `Save failed with status ${res.status}`);
      }

      const j = await res.json();
      const link = j.url ? `<a href="${j.url}" target="_blank" rel="noopener" class="text-blue-300 underline">View on GitHub</a>` : '';
      alert(`Saved ‚úÖ\n${j.url || ''}`);
      document.getElementById('selectedList').innerHTML =
        link || '<span class="text-xs text-slate-500">Saved.</span>';

    } catch(e){
      alert("Save failed:\n" + e.message);
    } finally {
      exportBtn.disabled = false;
      exportBtn.textContent = prevText;
    }
  }
  document.getElementById('exportBtn').onclick = uploadScheduleViaProxy;

  // Load button (fetch saved schedule for chosen name)
  async function loadScheduleForName(name) {
    const loadBtn = document.getElementById('loadBtn');
    const hasName = !!(name && name.trim());
    setSaveEnabled(hasName);
    if (!hasName) {
      state.data = {};
      saveStore();
      render();
      return;
    }

    // Clear then try to load
    state.data = {};
    saveStore();
    render();

    const url = SCHEDULE_BASE_URL + safeFileName(name) + "_TeamSched.json";
    try {
      loadBtn && (loadBtn.textContent = "Loading‚Ä¶", loadBtn.disabled = true);
      const res = await fetch(url, { headers: { "Accept":"application/json" } });
      if (!res.ok) {
        console.warn("No schedule found for", name, res.status);
        // Keep empty schedule but still enable Save for creating new file
        return;
      }
      const json = await res.json();
      const loaded = stripMeta(json);
      const valid = {};
      for (const [k, v] of Object.entries(loaded)) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(k) && typeof v === "string") valid[k] = v;
      }
      state.data = valid;
      saveStore();
      render();
    } catch (e) {
      console.error("Failed to load schedule:", e);
    } finally {
      if (loadBtn) {
        loadBtn.textContent = "Load";
        loadBtn.disabled = !hasName;
      }
    }
  }
  document.getElementById('loadBtn').onclick = async () => {
    const selName = document.getElementById('selName');
    const name = (selName.value || '').trim();
    if (!name) { alert("Pick a Name first."); selName.focus(); return; }
    await loadScheduleForName(name);
  };

  // Navigation (clamped)
  document.getElementById('prevBtn').onclick = ()=>{
    const d = new Date(state.viewYear, state.viewMonth - 1, 1);
    ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
    render();
  };
  document.getElementById('nextBtn').onclick = ()=>{
    const d = new Date(state.viewYear, state.viewMonth + 1, 1);
    ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
    render();
  };
  document.getElementById('todayBtn').onclick = ()=>{
    let target = new Date();
    if (CONFIG.START_DATE && target < CONFIG.START_DATE) target = CONFIG.START_DATE;
    if (CONFIG.END_DATE && target > CONFIG.END_DATE)     target = CONFIG.END_DATE;

    ({year: state.viewYear, month: state.viewMonth} = clampView(target.getFullYear(), target.getMonth()));
    state.focusDay = ymd(target);

    const wd = target.getDay();
    state.selected.clear();
    if (dateInRange(target) && !isHoliday(target) && wd !== 0 && wd !== 6) state.selected.add(state.focusDay);

    render();
  };
  document.getElementById('clearSelectionBtn').onclick = ()=>{ state.selected.clear(); render(); };

  // Init
  (async () => {
    loadStore();
    await loadConfig();
    await loadResponders();
    wireResponderEvents();
    setSaveEnabled(false);
    ({year: state.viewYear, month: state.viewMonth} = clampView(state.viewYear, state.viewMonth));
    render();
  })();
</script>
</body>
</html>
