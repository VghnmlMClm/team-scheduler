<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#2563eb}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .day-cell{user-select:none}
    .selected-day{outline:2px solid var(--brand); outline-offset:-2px}
    .today-ring{box-shadow:inset 0 0 0 2px var(--brand)}
    .muted{opacity:.35}
    .grad{background:linear-gradient(135deg,#1d4ed8 0%,#06b6d4 100%)}
    .hidden{display:none !important}
    select[multiple] option{padding:4px}
    #centerTable th,#centerTable td{padding:8px 10px; border-bottom:1px solid #1f2937}
    #centerTable th{position:sticky; top:0; background:#0f172a}
  </style>
</head>

<body class="bg-black text-slate-100">

<header class="grad text-white">
  <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col gap-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Dashboard toggle (stealth when disabled) -->
        <button id="toggleDashboardBtn"
          class="w-9 h-9 rounded-2xl bg-white/15 grid place-items-center transition"
          aria-label="Toggle view">
          <span id="dashIcon" class="text-lg">üóìÔ∏è</span>
        </button>
        <h1 id="appTitle" class="text-xl sm:text-2xl font-semibold">Scheduler</h1>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <!-- Dashboard-only Export menu -->
        <div id="exportGroup" class="relative hidden">
          <button id="exportFileBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">Export</button>
          <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-slate-900 border border-slate-700 rounded-lg shadow-lg overflow-hidden z-20">
            <button id="exportVlBtn" class="w-full px-3 py-2 text-left hover:bg-slate-800">VL Summary (.txt)</button>
            <button id="exportTableBtn" class="w-full px-3 py-2 text-left hover:bg-slate-800">Table (.xlsx)</button>
          </div>
        </div>
        <button id="loadBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 transition opacity-60 cursor-not-allowed">Refresh</button>
        <button id="exportBtn" disabled class="px-3 py-2 rounded-lg bg-white/10 transition opacity-60 cursor-not-allowed">Save</button>
      </div>
    </div>

<!-- Personnel filters -->
<div id="filtersWrap" class="grid grid-cols-1 gap-3 text-sm">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div>
      <label for="selTeam" class="block text-xs text-slate-300 mb-1">TEAM</label>
      <select id="selTeam" class="w-full px-3 py-1.5 rounded-lg text-sm bg-black border border-slate-700 text-white">
        <option value="">‚Äî all teams ‚Äî</option>
      </select>
    </div>
    <div>
      <label for="selPosition" class="block text-xs text-slate-300 mb-1">POSITION</label>
      <select id="selPosition" class="w-full px-3 py-1.5 rounded-lg text-sm bg-black border border-slate-700 text-white">
        <option value="">‚Äî all positions ‚Äî</option>
      </select>
    </div>
  </div>
  <div>
    <label for="selName" class="block text-xs text-slate-300 mb-1">NAME</label>
    <select id="selName" class="w-full px-3 py-1.5 rounded-lg text-sm bg-black border border-slate-700 text-white">
      <option value="">‚Äî select name ‚Äî</option>
    </select>
  </div>
</div>


<!-- PERSONNEL VIEW -->
<main id="personnelView" class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Calendar -->
  <section class="lg:col-span-2 bg-slate-900 text-slate-100 rounded-2xl shadow-sm border border-slate-800">
    <div class="p-4 border-b border-slate-700">
      <div class="flex justify-center items-center gap-4">
        <button id="prevBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Previous month">‚óÄ</button>
        <div class="text-center">
          <h2 id="monthLabel" class="text-lg font-semibold"></h2>
          <p id="selectedCount" class="text-xs text-slate-400"></p>
        </div>
        <button id="nextBtn" class="p-2 rounded-lg hover:bg-slate-800" title="Next month">‚ñ∂</button>
      </div>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-7 text-xs font-medium text-slate-400 mb-2 select-none">
        <div class="text-center">Sun</div><div class="text-center">Mon</div><div class="text-center">Tue</div>
        <div class="text-center">Wed</div><div class="text-center">Thu</div><div class="text-center">Fri</div><div class="text-center">Sat</div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>
  </section>

  <!-- Sidebar -->
  <aside class="bg-slate-900 text-slate-100 rounded-2xl shadow-sm border border-slate-800 overflow-hidden">
    <!-- GROUPED schedule buttons injected here -->
    <form id="eventForm" class="p-4 space-y-5" onsubmit="return false;">
      <div id="schedButtons" class="space-y-4"></div>
      <div class="flex items-center gap-3">
        <button id="deleteBtn" class="px-4 py-2 rounded-xl border border-slate-600 hover:bg-slate-800" type="button">Clear status on selected</button>
      </div>
    </form>

    <div class="px-4 pb-4 space-y-4">
      <!-- Selected -->
      <div>
        <div class="flex items-center justify-between mb-1">
          <h4 class="text-sm font-semibold">Selected:</h4>
          <button id="clearSelectionBtn" class="px-3 py-1.5 rounded-lg border border-slate-600 hover:bg-slate-800 text-xs">Clear selection</button>
        </div>
        <div id="selectedList" class="text-sm text-slate-300"></div>
      </div>
    </div>
  </aside>
</main>

<!-- DASHBOARD VIEW -->
<section id="dashboardView" class="hidden max-w-6xl mx-auto px-4 py-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- LEFT EDGE FILTERS -->
    <aside class="lg:col-span-3 bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <h3 class="text-sm font-semibold mb-3 text-slate-200">Filters</h3>
      <div class="mb-4">
        <label class="block text-xs mb-1 text-slate-400">IMMEDIATE SUPERVISOR(S)</label>
        <select id="fSupervisors" multiple class="w-full h-40 bg-black border border-slate-700 rounded-lg p-2 text-sm"></select>
        <p class="text-[11px] mt-1 text-slate-500">Click to toggle (no Ctrl/Cmd needed)</p>
      </div>
      <div class="mb-4">
        <label class="block text-xs mb-1 text-slate-400">SUBORDINATE POSITIONS</label>
        <select id="fPositions" multiple class="w-full h-32 bg-black border border-slate-700 rounded-lg p-2 text-sm"></select>
      </div>

      <!-- WORK / LEAVE SWITCH -->
      <div class="mt-4">
        <label class="block text-xs mb-2 text-slate-400">SCHEDULE MODE</label>
        <div id="typeSwitchWrap" class="inline-flex items-center bg-slate-800/60 border border-slate-700 rounded-xl overflow-hidden">
          <button id="btnWork"  class="px-3 py-1.5 text-sm hover:bg-slate-700/60">WORK</button>
          <button id="btnLeave" class="px-3 py-1.5 text-sm hover:bg-slate-700/60">LEAVE</button>
        </div>
        <div class="text-[11px] text-slate-500 mt-2" id="typeSwitchHint"></div>
      </div>
    </aside>

    <!-- CENTER (Table-like chart) -->
    <div class="lg:col-span-6 space-y-4">
      <!-- TOP METRICS (Date Range card removed) -->
      <div class="grid grid-cols-1 gap-4">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400">TOTAL RECORDS (Selected Types)</div>
          <div id="metricTotalVl" class="text-3xl font-semibold mt-1">‚Äî</div>
        </div>
      </div>

      <!-- Table-like chart -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="flex items-baseline justify-between">
          <h2 class="text-sm font-semibold mb-2 text-slate-200">Dates with Selected Schedules</h2>
          <span id="currentTypeCaption" class="text-[11px] text-slate-400"></span>
        </div>
        <div class="w-full overflow-auto max-h-[520px]">
          <table id="centerTable" class="min-w-full text-sm border-separate border-spacing-y-1">
            <!-- built in JS -->
          </table>
        </div>
        <p id="dashboardHint" class="mt-3 text-xs text-slate-400"></p>
      </div>
    </div>

    <!-- RIGHT: INCOMPLETE SCHEDULES LIST -->
    <aside class="lg:col-span-3 bg-slate-900 border border-slate-800 rounded-2xl p-4 overflow-auto">
      <h3 class="text-sm font-semibold mb-2 text-slate-200">INCOMPLETE SCHEDULES (Selected Supervisors)</h3>
      <div id="missingSubtitle" class="text-[11px] text-slate-500 mb-2">People under selected supervisor(s) with incomplete schedules in range.</div>
      <div id="missingWrap" class="overflow-auto max-h-[620px]">
        <div id="missingList" class="text-sm space-y-2"></div>
      </div>
    </aside>
  </div>
</section>

<footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
  <p>Tip: Hold <kbd class="px-1 rounded bg-slate-700 text-white">Shift</kbd> and click to select a range.</p>
</footer>

<script>
/* ===== Constants (URLs) ===== */
const PROXY_URL = "https://frosty-water-9f6a.voughn-calma-086.workers.dev/";
const RESPONDERS_URL = "Responders.json";
const CONFIG_URL = "config.json";
const ORG_URL = "organization.json";

/* ===== Schedule Options (no REST DAY/HOLIDAY buttons) ===== */
const SCHEDULE_OPTIONS = [
  { name:"ON-SITE",         code:"ONS",  abbr:"ONS", color:"ffffff" },
  { name:"OFFICE",          code:"OFC",  abbr:"OFC", color:"ffffff" },
  { name:"WORK FROM HOME",  code:"WFH",  abbr:"WFH", color:"b5e6a2" },
  { name:"VACATION LEAVE",  code:"VL",   abbr:"VL",  color:"f5c6ab" },
  { name:"AUTHORIZED ABSENT", code:"AA", abbr:"AA",  color:"ff0000" },
  { name:"PAID TIME OFF",   code:"PTO",  abbr:"PTO", color:"e87331" },
  { name:"BIRTHDAY LEAVE",  code:"BDL",  abbr:"BDL", color:"a02b93" },
  { name:"MATERNITY LEAVE", code:"ML",   abbr:"ML",  color:"f2ceef" },
  { name:"PATERNITY LEAVE", code:"PL",   abbr:"PL",  color:"0f9ed5" }
];

/* === Groups (display order) ===*/
const SCHEDULE_GROUPS = [
  { title: "WORK SETUP", codes: ["ONS","OFC","WFH"] },
  { title: "LEAVES", codes: ["VL","AA"] },
  { title: "SPECIAL LEAVES", codes: ["PTO","BDL","ML","PL"] }
];

/* Build color/label maps + helpers */
const LABELS = Object.fromEntries(SCHEDULE_OPTIONS.map(o => [o.code, o.abbr]));
const NAMES  = Object.fromEntries(SCHEDULE_OPTIONS.map(o => [o.code, o.name]));
const COLORS = Object.fromEntries([
  ...SCHEDULE_OPTIONS.map(o => [o.code, '#' + o.color.toLowerCase()]),
  ['RD',      '#808080'], // Rest Day (weekends)
  ['HOL',     '#ffff00'], // Holiday (from config.json)
  ['WEEKEND', '#808080']  // keep WEEKEND in sync with RD
]);

/* ===== Helpers ===== */
const stripMeta = o => Object.fromEntries(Object.entries(o||{}).filter(([k]) => !k.startsWith("_")));
const pad = n => String(n).padStart(2,'0');
const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const parseYMD = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); };
const normVal = v => String(v ?? "").trim();
const uniq = arr => [...new Set(arr)];
function fmtMMMDDYYYY(d){const MMM=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];return `${MMM[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;}
function hexToRGB(hex){ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(c=>c+c).join(''); const n=parseInt(hex,16); return {r:(n>>16)&255, g:(n>>8)&255, b:(n&255)}; }
function getContrastText(hex){ const {r,g,b}=hexToRGB(hex); const yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128 ? 'text-black' : 'text-white'; }

/* ===== State ===== */
const state = {
  viewYear: new Date().getFullYear(),
  viewMonth: new Date().getMonth(),
  selected: new Set(),
  focusDay: ymd(new Date()),
  lastClicked: null,
  storeKey: 'calendar-scheduler-v2',
  data: {},
  isDashboard: false,
  typeMode: 'LEAVE' // default to LEAVE
};

/* ===== Config & Holidays ===== */
let CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
const parseDateStr = s => { if (!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };
const dateInRange = d => {
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return true;
  const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return dd >= CONFIG.START_DATE && dd <= CONFIG.END_DATE;
};
const isHoliday = d => CONFIG.HOLIDAYS_SET.has(ymd(d));
async function loadConfig(){
  try{
    const r = await fetch(CONFIG_URL);
    const j = await r.json();
    CONFIG.START_DATE  = parseDateStr(j.START_DATE);
    CONFIG.END_DATE    = parseDateStr(j.END_DATE);
    CONFIG.HOLIDAYS_SET = new Set(Array.isArray(j.HOLIDAYS) ? j.HOLIDAYS : []);
  }catch{
    CONFIG = { START_DATE: null, END_DATE: null, HOLIDAYS_SET: new Set() };
  }
}
function clampView(year, month) {
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return { year, month };
  const monthLast  = new Date(year, month+1, 0);
  if (monthLast < CONFIG.START_DATE) return { year: CONFIG.START_DATE.getFullYear(), month: CONFIG.START_DATE.getMonth() };
  const monthFirst = new Date(year, month, 1);
  if (monthFirst > CONFIG.END_DATE) return { year: CONFIG.END_DATE.getFullYear(), month: CONFIG.END_DATE.getMonth() };
  return { year, month };
}
function updateTitleFromConfig(){
  const el = document.getElementById('appTitle');
  if (!el) return;
  const s = CONFIG.START_DATE, e = CONFIG.END_DATE;
  el.textContent = (s && e) ? `Scheduler (${fmtMMMDDYYYY(s)} - ${fmtMMMDDYYYY(e)})` : "Scheduler";
}

/* ===== Organization (hierarchy) ===== */
let ORG_INDEX = new Map();
let ORG_SUPERVISORS = []; // names that have TEAM (immediate supervisors)

async function loadOrganization(){
  try{
    const r = await fetch(ORG_URL);
    const data = await r.json();

    ORG_INDEX.clear();
    ORG_SUPERVISORS = [];

    if (Array.isArray(data)) {
      data.forEach(indexOrg);              // array of org nodes
    } else if (data && typeof data === 'object' && data.MANAGER) {
      indexOrg(data.MANAGER);              // schema with MANAGER root
    } else {
      indexOrg(data);                      // single node fallback
    }

    ORG_SUPERVISORS = Array.from(new Set(ORG_SUPERVISORS)).sort();
  }catch(e){
    console.error('loadOrganization error', e);
    ORG_INDEX.clear();
    ORG_SUPERVISORS = [];
  }
}

function indexOrg(node){
  if (!node || !node.NAME) return;
  ORG_INDEX.set(node.NAME, node);
  const team = Array.isArray(node.TEAM) ? node.TEAM : [];
  if (team.length > 0) ORG_SUPERVISORS.push(node.NAME);
  for (const child of team) indexOrg(child);
}

/* Returns all names under each selected supervisor (including the supervisor) */
function getSubtreeNames(supervisors){
  const out = new Set();
  function walk(node){
    if(!node || !node.NAME || out.has(node.NAME)) return;
    out.add(node.NAME);
    (node.TEAM||[]).forEach(walk);
  }
  supervisors.forEach(name=>{
    const node = ORG_INDEX.get(name);
    if (node) walk(node);
  });
  return [...out];
}

/* ===== Responders ===== */
let RESPONDERS = [];
async function loadResponders(){
  try{
    const res = await fetch(RESPONDERS_URL);
    const raw = await res.json();
    const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.rows) ? raw.rows : []);
    RESPONDERS = rows.map(r => ({
      POSITION:   normVal(r.POSITION   ?? r.position),
      DIVISION:   normVal(r.DIVISION   ?? r.division),
      DEPARTMENT: normVal(r.DEPARTMENT ?? r.department),
      TEAM:       normVal(r.TEAM       ?? r.team),
      NAME:       normVal(r.NAME       ?? r.name)
    })).filter(r => r.NAME);
  }catch(e){
    console.error("Failed to load responders:", e);
  }
}
function getAllNames(){ return uniq(RESPONDERS.map(r => r.NAME).filter(Boolean)); }
function getAllPositions(){ return uniq(RESPONDERS.map(r => r.POSITION || 'Unspecified')).sort(); }

/* ===== Local store ===== */
function loadStore(){
  try{ const raw = localStorage.getItem(state.storeKey); state.data = raw? JSON.parse(raw) : {}; }
  catch(e){ state.data = {}; }
}
function saveStore(){ localStorage.setItem(state.storeKey, JSON.stringify(state.data)); }

/* ===== Calendar UI ===== */
const grid = document.getElementById('calendarGrid');
const monthLabel = document.getElementById('monthLabel');
const selectedCount = document.getElementById('selectedCount');
const selectedList = document.getElementById('selectedList');

function monthName(m){return new Date(2000,m,1).toLocaleString(undefined,{month:'long'})}
function render(){
  const {viewYear, viewMonth} = state;
  monthLabel.textContent = `${monthName(viewMonth)} ${viewYear}`;
  renderGrid(viewYear, viewMonth);
  renderSelection();
}
function renderGrid(year, month){
  grid.innerHTML='';
  const first = new Date(year, month, 1);
  const last  = new Date(year, month+1, 0);
  const startWeekday = first.getDay();
  const prevLast = new Date(year, month, 0).getDate();

  for(let i=startWeekday-1; i>=0; i--) grid.appendChild(dayCell(new Date(year, month-1, prevLast - i), true));
  for(let d=1; d<=last.getDate(); d++) grid.appendChild(dayCell(new Date(year, month, d), false));
  const remaining = (7 - (grid.children.length % 7)) % 7;
  for(let i=1;i<=remaining;i++) grid.appendChild(dayCell(new Date(year, month+1, i), true));
}

function dayCell(dateObj, muted=false){
  const id = ymd(dateObj);
  const isToday   = id === ymd(new Date());
  const wd        = dateObj.getDay();
  const weekend   = (wd===0 || wd===6);
  const outRange  = !dateInRange(dateObj);
  const holiday   = isHoliday(dateObj);
  const isSelected= state.selected.has(id);
  const status    = state.data[id] || '';

  let bg = '';
  if (status)       bg = COLORS[status];
  else if (holiday) bg = COLORS.HOL;
  else if (weekend) bg = COLORS.RD;

  const disabled = outRange || holiday || weekend;

  const cell = document.createElement('button');
  cell.type='button';
  cell.className = [
    'day-cell aspect-square rounded-xl border border-slate-700 p-2 text-left transition',
    muted ? 'muted' : '',
    isSelected ? 'selected-day' : '',
    disabled ? 'cursor-not-allowed' : 'hover:border-blue-300'
  ].join(' ').trim();

  cell.dataset.date = id;
  if (bg) cell.style.background = bg;

  // Determine readable text color for date number
  let textColor = 'white';
  if (bg) {
    const contrast = getContrastText(bg);
    textColor = (contrast === 'text-black') ? 'black' : 'white';
  }

  // Determine badge label
  const badgeText = status
    ? LABELS[status]
    : (holiday ? 'HOL' : (weekend ? 'RD' : ''));

  // Badge adopts same text color as date label
  const badge = badgeText
    ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-black/10 border border-black/10" style="color:${textColor}">${badgeText}</span>`
    : '';

  cell.innerHTML = `
    <div class="flex items-center justify-between">
      <span class="w-7 h-7 rounded-full grid place-items-center ${isToday?'today-ring':''}"
            style="color:${textColor}">${dateObj.getDate()}</span>
    </div>
    <div class="mt-1 overflow-hidden">${badge}</div>
  `;

  cell.addEventListener('click', e => {
    if (disabled) return;
    onDayClick(id, e.shiftKey);
  });
  return cell;
}

function onDayClick(id, shift) {
  const date = parseYMD(id);
  const wd = date.getDay();
  if (!dateInRange(date)) return;
  if (isHoliday(date))    return; // holidays locked
  if (wd === 0 || wd === 6) return; // weekends locked

  if (shift && state.lastClicked) {
    const a = parseYMD(state.lastClicked), b = parseYMD(id);
    const [min, max] = a <= b ? [a, b] : [b, a];
    const cur = new Date(min);
    while (cur <= max) {
      const w = cur.getDay();
      if (dateInRange(cur) && !isHoliday(cur) && w !== 0 && w !== 6) {
        state.selected.add(ymd(cur));
      }
      cur.setDate(cur.getDate() + 1);
    }
  } else {
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
    state.lastClicked = id;
  }
  state.focusDay = id;
  render();
}
function renderSelection(){
  const items = Array.from(state.selected).sort();
  selectedCount.textContent = items.length? `${items.length} day(s) selected` : 'No days selected';
  selectedList.innerHTML = items.length
    ? `<div class="flex flex-wrap gap-2">${items.map(d=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-700">${d} ‚Äî ${state.data[d]? LABELS[state.data[d]] : '‚Äî'}</span>`).join('')}</div>`
    : '<p class="text-xs text-slate-500">Click weekdays (non-holiday) to select.</p>';
}

/* ===== Dynamic schedule controls (GROUPED) ===== */
function buildScheduleButtons(){
  const wrap = document.getElementById('schedButtons');
  wrap.innerHTML = '';

  SCHEDULE_GROUPS.forEach(group => {
    const block = document.createElement('div');
    block.className = 'rounded-xl border border-slate-800 p-3 bg-slate-900/40';

    const title = document.createElement('div');
    title.className = 'text-xs text-slate-400 mb-2';
    title.textContent = group.title;
    block.appendChild(title);

    // Each button in its own row
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 gap-2';

    group.codes.forEach(code => {
      const opt = SCHEDULE_OPTIONS.find(o => o.code === code);
      if (!opt) return;
      const color = '#' + opt.color.toLowerCase();
      const textClass = getContrastText(color);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `w-full px-3 py-2 rounded-xl font-medium shadow-sm hover:opacity-95 ${textClass}`;
      btn.style.background = color;
      btn.textContent = opt.name;
      btn.addEventListener('click', () => applyType(opt.code));
      grid.appendChild(btn);
    });

    block.appendChild(grid);
    wrap.appendChild(block);
  });
}

/* ===== Apply / Clear ===== */
document.getElementById('clearSelectionBtn').onclick = ()=>{ state.selected.clear(); render(); };
const deleteBtn = document.getElementById('deleteBtn');
deleteBtn.onclick = ()=>{
  if(!(state.selected.size || state.focusDay)) return;
  if(!confirm('Clear status from the selected day(s)?')) return;
  const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
  for(const d of targets){ delete state.data[d]; }
  saveStore(); render();
};
function applyType(val){
  const targets = state.selected.size? Array.from(state.selected) : [state.focusDay];
  for(const d of targets){
    const dt = parseYMD(d);
    const wd = dt.getDay();
    if (!dateInRange(dt)) continue;
    if (isHoliday(dt))    continue; // cannot set on holidays
    if (wd === 0 || wd === 6) continue; // cannot set on weekends
    state.data[d] = val;
  }
  saveStore(); state.selected.clear(); render();
}

/* ===== Responders dropdowns ===== */
function fillSelect(sel, values, selected, blankLabel = "‚Äî select ‚Äî") {
  sel.innerHTML =
    `<option value="">${blankLabel}</option>` +
    (values.length
      ? values.map(v => `<option value="${v}">${v}</option>`).join("")
      : `<option value="" disabled>‚Äî none ‚Äî</option>`);
  if (selected !== undefined) sel.value = selected;
}
function setSaveEnabled(enabled) {
  ['loadBtn','exportBtn'].forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-60', !enabled);
    btn.classList.toggle('cursor-not-allowed', !enabled);
  });
}
function populateRespondersUI(changed = null) {
  const teamSel = document.getElementById("selTeam");
  const posSel  = document.getElementById("selPosition");
  const nameSel = document.getElementById("selName");

  let cur = {
    TEAM:     normVal(teamSel?.value),
    POSITION: normVal(posSel?.value),
    NAME:     normVal(nameSel?.value),
  };

  // Reset lower levels when an upper filter changes
  if (changed === "TEAM")     { cur.POSITION = ""; cur.NAME = ""; }
  if (changed === "POSITION") { cur.NAME = ""; }

  const all = RESPONDERS;
  const uniqVals = (arr, field) => uniq(arr.map(r => normVal(r[field]))).sort();

  // TEAM
  const teamValues = uniqVals(all, "TEAM");
  if (cur.TEAM && !teamValues.includes(cur.TEAM)) cur.TEAM = "";
  fillSelect(teamSel, teamValues, cur.TEAM, "‚Äî all teams ‚Äî");

  // POSITION (scoped by TEAM)
  const scopeTeam = cur.TEAM ? all.filter(r => normVal(r.TEAM) === cur.TEAM) : all;
  const posValues = uniqVals(scopeTeam, "POSITION");
  if (cur.POSITION && !posValues.includes(cur.POSITION)) cur.POSITION = "";
  fillSelect(posSel, posValues, cur.POSITION, "‚Äî all positions ‚Äî");

  // NAME (scoped by TEAM & POSITION)
  let scopeForNames = scopeTeam;
  if (cur.POSITION) scopeForNames = scopeForNames.filter(r => normVal(r.POSITION) === cur.POSITION);
  const nameValues = uniq(scopeForNames.map(r => normVal(r.NAME))).sort();
  if (cur.NAME && !nameValues.includes(cur.NAME)) cur.NAME = "";
  fillSelect(nameSel, nameValues, cur.NAME, "‚Äî select name ‚Äî");

  // If no name, clear current grid preview
  if (!cur.NAME) {
    state.data = {};
    saveStore();
    render();
  }

  localStorage.setItem("responders-filters", JSON.stringify(cur));
  setSaveEnabled(!!cur.NAME);
  updateDashToggleEligibility();
}




function wireResponderEvents() {
  const teamSel = document.getElementById("selTeam");
  const posSel  = document.getElementById("selPosition");
  const nameSel = document.getElementById("selName");

  // Team change ‚Üí reset Position & Name, rebuild lists
  teamSel?.addEventListener("change", () => {
    populateRespondersUI("TEAM");
  });

  // Position change ‚Üí reset Name, rebuild list
  posSel?.addEventListener("change", () => {
    populateRespondersUI("POSITION");
  });

  // Name change ‚Üí rebuild (keeps selection) + load schedule
  nameSel?.addEventListener("change", async (e) => {
    populateRespondersUI("NAME");
    updateDashToggleEligibility();
    const name = (e.target?.value || "").trim();
    if (name) {
      await loadScheduleForName(name);  // <- restores ‚Äúselecting name pulls schedule‚Äù
    } else {
      // no name selected; ensure buttons reflect disabled state
      setSaveEnabled(false);
    }
  });
}


/* ===== Save via Worker (include preset HOL & RD) ===== */
async function uploadScheduleViaProxy(){
  const exportBtn = document.getElementById('exportBtn');
  const selName = document.getElementById('selName');
  const selDivision = document.getElementById('selDivision');
  const selDepartment = document.getElementById('selDepartment');
  const selTeam = document.getElementById('selTeam');
  const selPosition = document.getElementById('selPosition');

  const name = (selName.value || '').trim();
  if(!name){ alert("Pick a Name first."); selName.focus(); return; }

  if(Object.keys(state.data).length === 0){
    if(!confirm("Your schedule is empty. Save anyway?")) return;
  }

  exportBtn.disabled = true;
  const prevText = exportBtn.textContent;
  exportBtn.textContent = "Saving‚Ä¶";

  // Include preset HOL (holidays) + RD (weekends) in saved data
  const mergedData = { ...state.data };
  const d = new Date(CONFIG.START_DATE);
  while (d <= CONFIG.END_DATE) {
    const id = ymd(d);
    const wd = d.getDay();
    if (isHoliday(d)) {
      mergedData[id] = mergedData[id] || 'HOL';
    } else if (wd === 0 || wd === 6) {
      mergedData[id] = mergedData[id] || 'RD';
    }
    d.setDate(d.getDate() + 1);
  }

  const payload = {
    op: "save",
    name,
    data: {
      ...mergedData,
      _meta: {
        division: selDivision.value,
        department: selDepartment.value,
        team: selTeam.value,
        position: selPosition.value,
        name,
        lastSaved: new Date().toISOString()
      }
    }
  };

  try{
    const res = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify(payload),
    });

    let j = null;
    try { j = await res.json(); } catch {}
    if (!res.ok || !j?.ok) {
      const err = (j && (j.error || j.message)) || `HTTP ${res.status}`;
      throw new Error(err);
    }

    const link = j.url ? `<a href="${j.url}" target="_blank" rel="noopener" class="text-blue-300 underline">View on GitHub</a>` : '';
    alert(`Saved ‚úÖ\n${j.url || ''}`);
    document.getElementById('selectedList').innerHTML =
      link || '<span class="text-xs text-slate-500">Saved.</span>';

  } catch(e){
    alert("Save failed:\n" + (e?.message || e));
  } finally {
    exportBtn.disabled = false;
    exportBtn.textContent = prevText;
  }
}
document.getElementById('exportBtn').onclick = uploadScheduleViaProxy;

/* ===== Load person schedule (personnel view preview only) ===== */
async function loadScheduleForName(name) {
  const loadBtn = document.getElementById('loadBtn');
  const hasName = !!(name && name.trim());
  setSaveEnabled(hasName);

  // Reset current view
  state.data = {};
  saveStore();
  render();
  if (!hasName) return;

  const prevText = loadBtn ? loadBtn.textContent : '';
  if (loadBtn) { loadBtn.textContent = "Loading‚Ä¶"; loadBtn.disabled = true; }

  try {
    const r = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ op: "load", name })
    });
    const j = await r.json();

    if (!j?.ok) {
      console.warn("Worker responded with error:", j);
      render();
      return;
    }

    if (j.found && j.data) {
      const loaded = stripMeta(j.data);
      const valid = {};
      for (const [k, v] of Object.entries(loaded)) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(k) && typeof v === "string") valid[k] = v;
      }
      state.data = valid;
      saveStore();
      render();
    } else {
      render();
    }
  } catch (e) {
    console.error("Worker load error:", e);
  } finally {
    if (loadBtn) { loadBtn.textContent = prevText || "Refresh"; loadBtn.disabled = !hasName; }
  }
}
document.getElementById('loadBtn').onclick = async () => {
  const selName = document.getElementById('selName');
  const name = (selName.value || '').trim();
  if (!name) { alert("Pick a Name first."); selName.focus(); return; }
  await loadScheduleForName(name);
};

/* ===== Export (all) ===== */
function dateRangeList() {
  const out = [];
  if (!CONFIG.START_DATE || !CONFIG.END_DATE) return out;
  const d = new Date(CONFIG.START_DATE);
  while (d <= CONFIG.END_DATE) {
    out.push(ymd(d));
    d.setDate(d.getDate() + 1);
  }
  return out;
}
async function fetchScheduleData(name){
  try{
    const r = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ op: "load", name })
    });
    const j = await r.json();
    if (j?.ok && j.found && j.data) {
      return stripMeta(j.data);
    }
  }catch(e){
    console.warn("Fetch schedule failed for", name, e);
  }
  return {}; // not found or error
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
async function ensureXLSX(){
  if (window.XLSX) return;
  const urls = [
    "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"
  ];
  for (const url of urls) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("failed"));
        document.head.appendChild(s);
      });
      if (window.XLSX) return;
    } catch {}
  }
  throw new Error("Failed to load SheetJS (XLSX).");
}

/* Export menu wiring */
const exportFileBtn = document.getElementById('exportFileBtn');
const exportMenu    = document.getElementById('exportMenu');
const exportVlBtn   = document.getElementById('exportVlBtn');
const exportTableBtn= document.getElementById('exportTableBtn');
function toggleMenu(show){ exportMenu.classList.toggle('hidden', !show); }
if (exportFileBtn) exportFileBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const isHidden = exportMenu.classList.contains('hidden'); toggleMenu(isHidden); });
document.addEventListener('click', ()=> toggleMenu(false));

/* VL Summary (.txt) ‚Äî counts VL dates */
async function exportVlSummary(){
  const names = getFilteredNamesForDashboard();
  if (!names.length) { alert("No names match the current filters."); return; }

  const pairs = await Promise.all(names.map(async n => [n, await fetchScheduleData(n)]));
  const lines = [];

  for (const [name, data] of pairs) {
    lines.push(name);
    const vlDates = Object.entries(data || {})
      .filter(([k, v]) => v === 'VL' && dateInRange(parseYMD(k)))
      .map(([k]) => parseYMD(k))
      .sort((a,b)=>a-b);

    if (!vlDates.length) { lines.push("(no VL)"); lines.push(""); continue; }

    const groups = {};
    for (const d of vlDates) {
      const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      (groups[key] ||= []).push(d);
    }
    const keys = Object.keys(groups).sort();
    for (const key of keys) {
      const arr = groups[key];
      const label = arr[0].toLocaleString(undefined, { month:'long', year:'numeric' });
      const days = arr.map(d => d.getDate()).join(", ");
      lines.push(label);
      lines.push(days);
    }
    lines.push("");
  }

  const fname = `VL_Summary_${new Date().toISOString().slice(0,10)}.txt`;
  downloadBlob(lines.join("\n"), fname, "text/plain;charset=utf-8");
}
if (exportVlBtn) exportVlBtn.addEventListener('click', async ()=>{ toggleMenu(false); await exportVlSummary(); });

/* Table (.xlsx) */
async function exportTableXlsx(){
  await ensureXLSX();
  const names = getFilteredNamesForDashboard();
  if (!names.length) { alert("No names match the current filters."); return; }

  const dates = dateRangeList();
  if (!dates.length) { alert("Config START_DATE/END_DATE missing."); return; }

  const schedules = await Promise.all(names.map(async n => [n, await fetchScheduleData(n)]));

  const header = ["Name", ...dates];
  const rows = [header];
  const statusToCell = (code) => (code ? (LABELS[code] ?? code) : "");

  for (const [name, data] of schedules) {
    const row = [name];
    for (const d of dates) row.push(statusToCell(data?.[d] || ""));
    rows.push(row);
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!freeze"] = { xSplit: 1, ySplit: 1 };
  ws["!cols"] = [{ wch: 28 }, ...dates.map(() => ({ wch: 10 }))];
  XLSX.utils.book_append_sheet(wb, ws, "Schedule");

  const ts = new Date().toISOString().slice(0,10).replaceAll("-","");
  XLSX.writeFile(wb, `TeamSchedule_Table_${ts}.xlsx`);
}
if (exportTableBtn) exportTableBtn.addEventListener('click', async ()=>{ toggleMenu(false); await exportTableXlsx(); });

/* ===== Navigation ===== */
document.getElementById('prevBtn').onclick = ()=>{
  const d = new Date(state.viewYear, state.viewMonth - 1, 1);
  ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
  render();
};
document.getElementById('nextBtn').onclick = ()=>{
  const d = new Date(state.viewYear, state.viewMonth + 1, 1);
  ({year: state.viewYear, month: state.viewMonth} = clampView(d.getFullYear(), d.getMonth()));
  render();
};

/* ===== Dashboard view & filters ===== */
const $toggleDash = document.getElementById('toggleDashboardBtn');
const $filtersWrap = document.getElementById('filtersWrap');
const $personnelView = document.getElementById('personnelView');
const $dashboardView = document.getElementById('dashboardView');
const $loadBtn = document.getElementById('loadBtn');
const $saveBtn = document.getElementById('exportBtn');
const $exportGroup = document.getElementById('exportGroup');

const $fSupervisors = document.getElementById('fSupervisors');
const $fPositions   = document.getElementById('fPositions');
const $metricTotal  = document.getElementById('metricTotalVl');
const $centerTable  = document.getElementById('centerTable');
const $hint         = document.getElementById('dashboardHint');
const $currentTypeCaption = document.getElementById('currentTypeCaption');
const $missingList  = document.getElementById('missingList');
const $missingSubtitle = document.getElementById('missingSubtitle');

/* ---------- Dashboard eligibility (stealth when not eligible) ---------- */
const DASH_ALLOWED_POS = new Set([
  'senior gis specialist',
  'deputy manager',
  'manager'
]);
function getSelectedResponderPositionLower() {
  const nameSel = document.getElementById('selName');
  const name = (nameSel?.value || '').trim();
  if (!name) return null;
  const r = RESPONDERS.find(x => (x.NAME || '') === name);
  return (r?.POSITION ?? '').trim().toLowerCase() || null;
}
function isDashboardEligible() {
  const pos = getSelectedResponderPositionLower();
  return !!pos && DASH_ALLOWED_POS.has(pos);
}
function setDashToggleDisabled(disabled) {
  const btn = document.getElementById('toggleDashboardBtn');
  if (!btn) return;
  if (disabled) {
    btn.disabled = true;
    btn.removeAttribute('title');
    btn.setAttribute('aria-disabled', 'true');
    btn.setAttribute('tabindex', '-1');
    btn.classList.remove('hover:bg-white/25','cursor-pointer','focus:outline-none','focus:ring');
    btn.classList.add('cursor-default','select-none','pointer-events-none');
  } else {
    btn.disabled = false;
    btn.removeAttribute('aria-disabled');
    btn.removeAttribute('tabindex');
    btn.classList.add('hover:bg-white/25','cursor-pointer','focus:outline-none');
    btn.classList.remove('cursor-default','select-none','pointer-events-none');
    btn.title = state.isDashboard ? 'Switch to Personnel View' : 'Switch to Dashboard View';
  }
}
function updateDashToggleEligibility(){
  if (state.isDashboard) { setDashToggleDisabled(false); return; }
  setDashToggleDisabled(!isDashboardEligible());
}

/* ---- WORK/LEAVE mode ---- */
const WORK_CODES  = ['ONS','WFH','OFC'];
const LEAVE_CODES = ['VL','AA','PTO','PL','ML','BDL'];
function getSelectedTypeCodes(){ return state.typeMode === 'WORK' ? WORK_CODES : LEAVE_CODES; }
function renderTypeSwitch(){
  const $work  = document.getElementById('btnWork');
  const $leave = document.getElementById('btnLeave');
  const $hint  = document.getElementById('typeSwitchHint');
  const active   = 'bg-blue-600 text-white';
  const inactive = 'text-slate-200';
  [$work,$leave].forEach(el=>el.className='px-3 py-1.5 text-sm hover:bg-slate-700/60 '+inactive);
  if(state.typeMode==='WORK'){
    $work.className='px-3 py-1.5 text-sm '+active;
    $hint.textContent='Showing: ON-SITE, WORK FROM HOME, OFFICE';
  }else{
    $leave.className='px-3 py-1.5 text-sm '+active;
    $hint.textContent='Showing: VACATION LEAVE, AUTHORIZED ABSENT, PTO, PATERNITY, MATERNITY, BIRTHDAY';
  }
  $work.onclick = ()=>{ if(state.typeMode!=='WORK'){ state.typeMode='WORK'; renderTypeSwitch(); buildDashboard(); } };
  $leave.onclick= ()=>{ if(state.typeMode!=='LEAVE'){ state.typeMode='LEAVE'; renderTypeSwitch(); buildDashboard(); } };
}

/* Helpers for completeness */
function isWeekend(d){ const w=d.getDay(); return w===0||w===6; }
function hasCompleteScheduleForRange(dataObj, selectedTypes){
  if(!CONFIG.START_DATE||!CONFIG.END_DATE) return false;
  const selected=new Set(selectedTypes);
  const d=new Date(CONFIG.START_DATE);
  while(d<=CONFIG.END_DATE){
    const id=ymd(d);
    const v=dataObj?.[id];
    if(isHoliday(d)){ if(v!=='HOL') return false; }
    else if(isWeekend(d)){ if(v!=='RD') return false; }
    else { if(!v || !selected.has(v)) return false; }
    d.setDate(d.getDate()+1);
  }
  return true;
}

/* Dashboard filter helper */
function getFilteredNamesForDashboard() {
  if (!state.isDashboard) return getAllNames().sort();

  const supervisors = Array.from(($fSupervisors?.selectedOptions || [])).map(o => o.value);
  const selectedPositions = new Set(Array.from(($fPositions?.selectedOptions || [])).map(o => o.value));

  let names = supervisors.length ? getSubtreeNames(supervisors) : getAllNames();

  if (selectedPositions.size) {
    const posMap = new Map(RESPONDERS.map(r => [r.NAME, r.POSITION || 'Unspecified']));
    names = names.filter(n => selectedPositions.has(posMap.get(n) || 'Unspecified'));
  }
  return names.sort();
}

/* Toggle handler */
$toggleDash.addEventListener('click', async () => {
  if (!state.isDashboard && !isDashboardEligible()) return;

  state.isDashboard = !state.isDashboard;
  if (state.isDashboard) {
    enterDashboard();
    await prepareDashboardFilters();
    renderTypeSwitch();
    await autoApplySupervisorFromName();
    await buildDashboard();
  } else {
    exitDashboard();
  }
});
function enterDashboard(){
  $filtersWrap.classList.add('hidden');
  $loadBtn.classList.add('hidden');
  $saveBtn.classList.add('hidden');
  $exportGroup.classList.remove('hidden');
  $personnelView.classList.add('hidden');
  $dashboardView.classList.remove('hidden');
  document.getElementById('dashIcon').textContent = 'üë•';
  setDashToggleDisabled(false); // allow going back
}
function exitDashboard(){
  $filtersWrap.classList.remove('hidden');
  $loadBtn.classList.remove('hidden');
  $saveBtn.classList.remove('hidden');
  $exportGroup.classList.add('hidden');
  $dashboardView.classList.add('hidden');
  $personnelView.classList.remove('hidden');
  document.getElementById('dashIcon').textContent = 'üóìÔ∏è';
  updateDashToggleEligibility();
}

/* Fill filter lists (supervisors = only names with TEAM) + click-to-toggle selection */
async function prepareDashboardFilters(){
  const supList = ORG_SUPERVISORS.slice().sort();
  $fSupervisors.innerHTML = supList.map(n => `<option>${n}</option>`).join('');

  const allPos = getAllPositions();
  $fPositions.innerHTML = allPos.map(p => `<option>${p}</option>`).join('');

  // Safe toggle helper with error guard
  function safeBuildDashboard() {
    try { buildDashboard(); }
    catch (err) {
      console.error('buildDashboard error:', err);
      // keep UI responsive even if a data issue occurs
    }
  }

  function toggleSelectOption(selectEl, option) {
    option.selected = !option.selected;
    // Force a "change" event so any listeners tied to it still run
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
    // And rebuild safely
    safeBuildDashboard();
    // Avoid the browser changing selection after our manual toggle
    selectEl.blur();
  }

  // Standard change listeners
  $fSupervisors.onchange = safeBuildDashboard;
  $fPositions.onchange   = safeBuildDashboard;

  // Robust click-to-toggle without Ctrl/Cmd
  [$fSupervisors, $fPositions].forEach(selectEl => {
    selectEl.addEventListener('mousedown', e => {
      // Only intercept when actually clicking an OPTION element
      const option = e.target && e.target.closest && e.target.closest('option');
      if (!option || option.disabled) return;
      e.preventDefault(); // stop native selection behavior
      toggleSelectOption(selectEl, option);
    });
  });
}


/* Auto-apply selected Name as supervisor (one-time on entry) */
async function autoApplySupervisorFromName(){
  const nameSel = document.getElementById('selName');
  const chosen = (nameSel?.value || '').trim();
  if (!chosen || !$fSupervisors) return;

  const opts = Array.from($fSupervisors.options);
  const idx = opts.findIndex(o => (o.value || o.textContent).trim() === chosen);
  if (idx >= 0) {
    $fSupervisors.selectedIndex = -1;
    opts.forEach(o => (o.selected = false));
    opts[idx].selected = true;
  }
}

/* Build dashboard (table-like) using selected schedule types */
async function buildDashboard(){
  $hint.textContent = 'Loading‚Ä¶';
  $centerTable.innerHTML = '';
  $missingList.innerHTML = '';

  const selectedTypes = getSelectedTypeCodes();
  $currentTypeCaption.textContent = selectedTypes.length
    ? `Types: ${selectedTypes.map(c=>NAMES[c]||c).join(', ')}`
    : 'Types: (none)';

  const selectedSupervisors = Array.from($fSupervisors.selectedOptions).map(o => o.value);
  const selectedPositions   = Array.from($fPositions.selectedOptions).map(o => o.value);

  let allowedNames = selectedSupervisors.length ? getSubtreeNames(selectedSupervisors) : getAllNames();

  const posMap = new Map(RESPONDERS.map(r => [r.NAME, r.POSITION || 'Unspecified']));
  if (selectedPositions.length) {
    const set = new Set(selectedPositions);
    allowedNames = allowedNames.filter(n => set.has(posMap.get(n) || 'Unspecified'));
  }

  const pairs = await Promise.all(allowedNames.map(async n => [n, await fetchScheduleData(n)]));

  // Aggregate: date -> list of {name, code}
  const dateToPeople = new Map();
  const dates = dateRangeList();
  const dateSet = new Set(dates);
  let totalRecords = 0;

  for (const [name, sched] of pairs) {
    for (const [d, code] of Object.entries(sched || {})) {
      if (!dateSet.has(d)) continue;
      if (!selectedTypes.length) continue;
      if (!selectedTypes.includes(code)) continue; // only selected codes
      if (!dateToPeople.has(d)) dateToPeople.set(d, []);
      dateToPeople.get(d).push({ name, code });
      totalRecords++;
    }
  }

  // Build metric
  $metricTotal.textContent = String(totalRecords);

  // Build center table (Date | Count | People (Name [CODE]))
  const rows = Array.from(dateToPeople.entries())
    .map(([d, people]) => [d, people.slice().sort((a,b)=> a.name.localeCompare(b.name))])
    .sort((a,b)=>(a[0] < b[0] ? -1 : 1));

  let html = '<thead><tr>';
  html += '<th class="text-left">Date</th>';
  html += '<th class="text-left">Count</th>';
  html += '<th class="text-left">People</th>';
  html += '</tr></thead><tbody>';

  for (const [d, people] of rows) {
    const list = people.map(p => `${p.name} [${LABELS[p.code]||p.code}]`).join(', ');
    html += `<tr>
      <td class="whitespace-nowrap">${new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}</td>
      <td>${people.length}</td>
      <td class="text-slate-300">${list}</td>
    </tr>`;
  }
  html += '</tbody>';
  $centerTable.innerHTML = rows.length ? html : '<tbody><tr><td class="text-slate-400">No data for selected filters/types.</td></tr></tbody>';

  // --- RIGHT PANEL: Incomplete schedules ---
  const nameToData = new Map(pairs.map(([n,d])=>[n,d||{}]));
  const incomplete = allowedNames.filter(n=>!hasCompleteScheduleForRange(nameToData.get(n),selectedTypes)).sort((a,b)=>a.localeCompare(b));
  if(!incomplete.length){
    $missingList.innerHTML=`<div class="text-slate-400 text-sm">Everyone under the selected supervisor(s) has a complete schedule for the range.</div>`;
  }else{
    $missingList.innerHTML=incomplete.map(n=>{
      const pos=posMap.get(n)||'Unspecified';
      return `<div class="flex items-start gap-2">
        <span class="w-2 h-2 mt-2 rounded-full bg-yellow-500/80"></span>
        <div><div class="font-medium">${n}</div><div class="text-xs text-slate-400">${pos}</div></div>
      </div>`;
    }).join('');
  }
  $missingSubtitle.textContent =
    `Under: ${($fSupervisors&&Array.from($fSupervisors.selectedOptions).map(o=>o.value).join(', '))||'All supervisors'} ‚Ä¢ `+
    (selectedTypes.length?`Weekday types considered: ${selectedTypes.join(', ')}`:'No weekday types selected');

  $hint.textContent = rows.length ? 'Showing selected schedule types per day.' : 'Adjust filters or schedule types.';
}

/* ===== Init ===== */
(async () => {
  loadStore();
  await loadConfig();
  updateTitleFromConfig();
  await loadResponders();
  await loadOrganization();

  // GROUPED schedule controls
  buildScheduleButtons();

  // Populate personnel filters once responders loaded
  populateRespondersUI();
  wireResponderEvents();
  setSaveEnabled(false);
  ({year: state.viewYear, month: state.viewMonth} = clampView(state.viewYear, state.viewMonth));
  render();

  // Initial eligibility (stealth if not eligible)
  updateDashToggleEligibility();
})();
</script>
</body>
</html>
